<script>
(function () {
  const { $, $$, getClientCache, setClientCache, clearClientCache } = window.SPCA || {};
  const SCHEDULER = () => (typeof getSchedulerName === 'function' ? getSchedulerName() : '');

  // Public entry from navigation when user clicks "Modify"
  window.renderModifyFlow = function renderModifyFlow(container) {
    // if Who-Are-You wrapper didnâ€™t catch it, ensure we have a name
    if (!SCHEDULER()) {
        if (typeof showWhoAreYouScreen === 'function') {
            return showWhoAreYouScreen(container, () => renderModifyFlow(container));
        }
    }   
    renderSearch(container);
  };

  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // Search Screen
  function renderSearch(container) {
    container.innerHTML = `
        <div class="schedule-step">
        <h2>Find an Appointment to Modify</h2>
        <div class="grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.75rem;">
            
            <div class="field">
              <label>Date (MM/DD/YYYY)</label>
              <div style="display:flex; align-items:center; gap:8px;">
                <input id="mDate" type="text" placeholder="MM/DD/YYYY" maxlength="10">
                <div style="position:relative; width:32px; height:32px; flex-shrink:0;">
                   <input id="mDatePicker" type="date" 
                          style="position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%; z-index:2;">
                   <button class="btn secondary" style="width:100%; height:100%; padding:0; display:flex; align-items:center; justify-content:center;">
                     ðŸ“…
                   </button>
                </div>
              </div>
            </div>

            <div class="field">
            <label>Client Name (exact, case-insensitive)</label>
            <input id="mClient" type="text" placeholder="First, Last, or First Last">
            </div>
            <div class="field">
            <label>Pet Name (exact, case-insensitive)</label>
            <input id="mPet" type="text" placeholder="e.g., Max">
            </div>
        </div>
        <div class="actions">
            <button id="mSearchBtn" class="btn">Search</button>
            <button id="mClearBtn" class="btn secondary">Clear</button>
        </div>
        <div id="mResults" style="margin-top:1rem;"></div>
        </div>
    `;

    const mDate = container.querySelector('#mDate');
    const mDatePicker = container.querySelector('#mDatePicker');
    const mClient = container.querySelector('#mClient');
    const mPet = container.querySelector('#mPet');
    const results = container.querySelector('#mResults');
    const searchBtn = container.querySelector('#mSearchBtn');

    // â”€â”€â”€ 1. Date Logic (Auto-Format & Picker) â”€â”€â”€
    
    // A. Sync Picker -> Text
    mDatePicker.addEventListener('change', () => {
      if (mDatePicker.value) {
        // Picker returns YYYY-MM-DD, convert to MM/DD/YYYY
        const [y, m, d] = mDatePicker.value.split('-');
        mDate.value = `${m}/${d}/${y}`;
      }
    });

    // B. Typing Logic (12082025 -> 12/08/2025)
    mDate.addEventListener('input', (e) => {
      let v = e.target.value.replace(/\D/g, ''); // strip non-digits
      if (v.length >= 5) v = `${v.slice(0,2)}/${v.slice(2,4)}/${v.slice(4,8)}`;
      else if (v.length >= 3) v = `${v.slice(0,2)}/${v.slice(2)}`;
      e.target.value = v;
    });

    // C. Pad Logic on Blur (1/1/25 -> 01/01/2025)
    const normalizeDate = () => {
      const raw = mDate.value.trim();
      if (!raw) return;
      const parts = raw.split('/');
      if (parts.length === 3) {
        let m = parts[0];
        let d = parts[1];
        let y = parts[2];
        
        // Pad Single Digits
        if (m.length === 1) m = '0' + m;
        if (d.length === 1) d = '0' + d;
        
        // Handle Short Year (25 -> 2025)
        if (y.length === 2) y = '20' + y;
        
        mDate.value = `${m}/${d}/${y}`;
      }
    };
    mDate.addEventListener('change', normalizeDate);
    mDate.addEventListener('blur', normalizeDate);

    // â”€â”€â”€ 2. Trigger Search on Enter â”€â”€â”€
    [mDate, mClient, mPet].forEach(input => {
      input.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') searchBtn.click();
      });
    });

    // â”€â”€â”€ 3. Search Button Listener â”€â”€â”€
    searchBtn.addEventListener('click', () => {
        normalizeDate(); // Ensure date is formatted before sending
        
        results.innerHTML = `<div class="spinner"></div>`;
        results.scrollIntoView({ behavior: 'smooth' });

        google.script.run
        .withSuccessHandler(res => {
            const spinner = results.querySelector('.spinner');
            if (spinner) spinner.remove();

            if (!res || !res.ok) {
                results.innerHTML = `<p class="error">${res?.error || 'Search failed.'}</p>`;
                results.scrollIntoView({ behavior: 'smooth' });
                return;
            }

            renderResults(results, res.rows || []);
        })
        .withFailureHandler(err => {
            console.error(err);
            const spinner = results.querySelector('.spinner');
            if (spinner) spinner.remove();
            results.innerHTML = `<p class="error">Server error during search.</p>`;
            results.scrollIntoView({ behavior: 'smooth' });
        })
        .apiSearchAppointments({
            date: mDate.value.trim(),
            client: mClient.value.trim(),
            pet: mPet.value.trim()
        });
    });

    // â”€â”€â”€ 4. Clear button â”€â”€â”€
    container.querySelector('#mClearBtn').addEventListener('click', () => {
        mDate.value = '';
        mDatePicker.value = ''; // Clear picker too
        mClient.value = '';
        mPet.value = '';
        results.innerHTML = '';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }

  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // Results list (cards)
    function renderResults(target, rows) {
    // ðŸ”¹ Remove any active spinner first
    const spinner = target.querySelector('.spinner');
    if (spinner) spinner.remove();

    // ðŸ”¹ Smooth scroll user to results area
    target.scrollIntoView({ behavior: 'smooth' });

    if (!rows.length) {
        target.innerHTML = `<p style="opacity:.7;">No matching appointments found.</p>`;
        return;
    }

    // ðŸ”¹ Build grid normally
    const grid = document.createElement('div');
    grid.className = 'card-grid';
    target.innerHTML = '';
    target.appendChild(grid);

    rows.forEach(r => {
        const disabled = !r.editable;
        const card = document.createElement('div');
        card.className = 'card';
        if (disabled) card.style.opacity = 0.6;

        card.innerHTML = `
        <div style="font-weight:600; margin-bottom:4px;">${r.firstName} ${r.lastName} â€” ${r.petName}</div>
        <div>${r.date} ${r.time || ''}</div>
        <div>Status: ${r.status || 'â€”'}</div>
        <div style="font-size:.85rem; opacity:.65;">ID: ${r.id}</div>
        ${disabled ? `<div class="success-message" style="margin-top:.6rem; background:#fffbea; color:#92400e;">Not editable (on or before today)</div>` : ``}
        `;

        if (!disabled) {
        card.style.cursor = 'pointer';
        card.addEventListener('click', () => openEditForm(target.parentElement, r));
        }

        grid.appendChild(card);
    });
    }

  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // Edit Form (same fields as scheduling, prefilled)
  function openEditForm(container, row) {
    container.innerHTML = `
      <div class="schedule-step">
        <h2>Edit Appointment</h2>
        <div id="formFields"></div>
        <div class="actions">
          <button id="mSave" class="btn">Save</button>
          <button id="mCancel" class="btn secondary">Cancel</button>
        </div>
        <div id="mConfirm" class="hidden"><div class="spinner"></div></div>
      </div>
    `;

    const formHost = container.querySelector('#formFields');
    // Render the same form structure used in Schedule flow,
    // but pre-fill with row values (we only render a reduced set here for brevity).
    formHost.innerHTML = `
      <div class="field"><label>First Name</label><input id="firstName" value="${safe(row.firstName)}"></div>
      <div class="field"><label>Last Name</label><input id="lastName" value="${safe(row.lastName)}"></div>
      <div class="field"><label>Email</label><input id="email" value="${safe(row.email)}"></div>
      <div class="field"><label>Phone Number</label><input id="phone" value="${safe(row.phone)}"></div>

      <hr class="divider">
      <h3>Address</h3>
      <div class="field"><label>Address</label><input id="address" value="${safe(row.address)}"></div>
      <div class="field"><label>City</label><input id="city" value="${safe(row.city)}"></div>
      <div class="field">
        <label>State</label>
        <select id="state">${getStatesOptions(row.state)}</select>
      </div>
      <div class="field"><label>Zip Code</label><input id="zip" value="${safe(row.zip)}"></div>

      <hr class="divider">
      <h3>Pet</h3>
      <div class="field"><label>Pet Name</label><input id="petName" value="${safe(row.petName)}"></div>
      <div class="field">
        <label>Species</label>
        <select id="species">
          <option value="">â€” Select â€”</option>
          ${['Canine','Feline','Other'].map(o => `<option ${row.species===o?'selected':''}>${o}</option>`).join('')}
        </select>
      </div>
      <div class="field"><label>Primary Breed</label><input id="breedOne" value="${safe(row.breedOne)}"></div>
      <div class="field"><label>Secondary Breed</label><input id="breedTwo" value="${safe(row.breedTwo)}"></div>
      <div class="field"><label>Color</label><input id="color" value="${safe(row.color)}"></div>
      <div class="field"><label>Color Pattern</label><input id="colorPattern" value="${safe(row.colorPattern)}"></div>

      <div class="field">
        <label>Sex</label>
        <select id="sex">
          <option value="">â€” Select â€”</option>
          ${['Male','Female'].map(o => `<option ${row.sex===o?'selected':''}>${o}</option>`).join('')}
        </select>
      </div>
      <div class="field">
        <label>Spayed or Neutered</label>
        <select id="altered">
          <option value="">â€” Select â€”</option>
          ${['Spayed','Neutered','No','Unknown'].map(o => `<option ${row.altered===o?'selected':''}>${o}</option>`).join('')}
        </select>
      </div>

      <div class="field"><label>Age</label><input id="age" value="${safe(row.age)}" placeholder="e.g., 2 years or 8 months"></div>

      <div class="field">
        <label>Vaccines Needed</label>
        <div id="vaccines" class="option-list"></div>
      </div>

      <div class="field">
        <label>Additional Services</label>
        <div id="additionalServices" class="option-list"></div>
      </div>

      <div class="field">
        <label>Previous Vet Records?</label>
        <div class="option-buttons-left">
          ${radio('hasVetRecords','Yes', row.prevRecords==='Yes')}
          ${radio('hasVetRecords','No',  row.prevRecords!=='Yes')}
        </div>
      </div>

      <div class="field"><label>Vet Office Name</label><input id="vetOffice" value="${safe(row.vetOffice)}"></div>

      <div class="field"><label>Allergies or Sensitivities</label><input id="allergies" value="${safe(row.allergies)}" placeholder="None known"></div>
      <div class="field"><label>Approx. Weight (lbs)</label><input id="weight" type="number" step="0.1" value="${safe(row.weight)}"></div>
      <div class="field"><label>Additional Notes</label><textarea id="notes" rows="3">${safe(row.notes)}</textarea></div>

      <div class="field">
        <label>Appointment Status</label>
        <select id="status">
          ${['Available','Scheduled','Reserved','Completed','Cancelled'].map(o => `<option ${row.status===o?'selected':''}>${o}</option>`).join('')}
        </select>
      </div>
    `;

    // hydrate vaccines & additional services with checks
    google.script.run.withSuccessHandler(res => {
      if (!res || !res.ok) return;
      const chosen = csvToArray(row.vaccines || '');
      const host = container.querySelector('#vaccines');
      const speciesVal = row.species;
      const list = speciesVal === 'Canine' ? (res.canine || []) : speciesVal === 'Feline' ? (res.feline || []) : [];
      host.innerHTML = list.map(v => `
        <label class="radio-option">
          <input type="checkbox" name="vaccine" value="${v}" ${chosen.includes(v) ? 'checked':''}> ${v}
        </label>
      `).join('');
    }).apiGetVaccineLists();

    google.script.run.withSuccessHandler(res => {
      if (!res || !res.ok) return;
      const chosen = csvToArray(row.additionalServices || '');
      const host = container.querySelector('#additionalServices');
      host.innerHTML = (res.services || []).map(s => `
        <label class="radio-option">
          <input type="checkbox" name="service" value="${s}" ${chosen.includes(s) ? 'checked':''}> ${s}
        </label>
      `).join('');
    }).apiGetAdditionalServices();

    // Save / Cancel
    // Save / Cancel
    const confirmBlock = container.querySelector('#mConfirm');
    container.querySelector('#mCancel').addEventListener('click', () => {
    // back to search
    renderModifyFlow(container);
    });

    container.querySelector('#mSave').addEventListener('click', e => {
    e.target.disabled = true; // âœ… Prevent double-click
    const payload = collectPayload(container);
    showTransportModal(container, row, payload);
    });
  }

  function collectPayload(container) {
    const get = id => container.querySelector('#' + id)?.value?.trim() || '';
    const checkedVals = (name) => [...container.querySelectorAll(`input[name="${name}"]:checked`)].map(el => el.value).join(', ');

    return {
      'First Name': get('firstName'),
      'Last Name': get('lastName'),
      'Email': get('email'),
      'Phone Number': get('phone'),
      'Address': get('address'),
      'City': get('city'),
      'State': get('state'),
      'Zip Code': get('zip'),
      'Pet Name': get('petName'),
      'Species': get('species'),
      'Sex': get('sex'),
      'Spayed or Neutered': get('altered'),
      'Age': get('age'),
      'Breed One': get('breedOne'),
      'Breed Two': get('breedTwo'),
      'Color': get('color'),
      'Color Pattern': get('colorPattern'),
      'Vaccines Needed': checkedVals('vaccine'),
      'Additional Services': checkedVals('service'),
      'Allergies or Sensitivities': get('allergies') || 'None known',
      'Weight': get('weight'),
      'Notes': get('notes'),
      'Previous Vet Records': (container.querySelector('input[name="hasVetRecords"]:checked')?.value || 'No'),
      'Vet Office Name': get('vetOffice'),
      'Appointment Status': get('status')
    };
  }

  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // Transport & Upload link modal (for modify flow)
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // Transport & Upload link modal (for modify flow)
  function showTransportModal(container, row, payload) {
    document.querySelectorAll('.modal').forEach(m => m.remove());
    const modal = document.createElement('div');
    modal.className = 'modal';
    const prevYes = (payload['Previous Vet Records'] === 'Yes');

    // 1. Determine Current Selection Text
    // Only show if the backend returned a value (won't show for new bookings if reused)
    const currentTransport = row.transportNeeded || '';
    const currentTextHtml = currentTransport 
      ? `<p style="margin-top:-0.5rem; margin-bottom:1.25rem; color:#4b5563; font-size:0.95rem; background:#f3f4f6; display:inline-block; padding:0.25rem 0.75rem; border-radius:8px;">
           Current Selection: <strong>${currentTransport}</strong>
         </p>` 
      : '';

    // 2. Pre-select the button if we want (Optional UX enhancement)
    // If you want the buttons to auto-select based on previous value, let me know! 
    // For now, we just show the text as requested.

    modal.innerHTML = `
      <div class="modal-content">
        <p style="margin-bottom:0.5rem;">Does this client require transportation assistance for this appointment?</p>
        ${currentTextHtml}
        
        <div class="actions transport-actions">
          <button class="btn transportBtn" data-transport="Yes">Yes</button>
          <button class="btn transportBtn" data-transport="No">No</button>
        </div>
        ${prevYes ? `
          <hr class="divider">
          <p>Please use the link below to upload any additional records you have at this time. Previous uploads will not be deleted.</p>
          <p><a href="https://script.google.com/macros/s/AKfycbxb1_Oha9qhWnaOMeUuFHSSEe5E7IoCPG2JPdkCn4Jmju-2VYiQzOobecO9DwKcC_pf/exec" target="_blank" rel="noopener">Open Vet Records Uploader</a></p>
        ` : ``}
        <hr class="divider">
        <div class="actions">
          <button id="mSubmit" class="btn" disabled>Submit</button>
          <button id="mCancelModal" class="btn secondary">Cancel</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);

    let chosenTransport = '';
    modal.querySelectorAll('.transportBtn').forEach(b => {
      b.addEventListener('click', () => {
        modal.querySelectorAll('.transportBtn').forEach(x => x.classList.remove('selected'));
        b.classList.add('selected');
        chosenTransport = b.dataset.transport;
        modal.querySelector('#mSubmit').disabled = !chosenTransport;
      });
    });

    modal.querySelector('#mCancelModal').addEventListener('click', () => modal.remove());
    modal.querySelector('#mSubmit').addEventListener('click', () => {
      modal.querySelector('#mSubmit').classList.add('loading');
      google.script.run
        .withSuccessHandler(res => {
          modal.remove();
          if (!res || !res.ok) {
            container.innerHTML = `<p class="error">${res?.error || 'Update failed.'}</p>`;
            return;
          }
          container.innerHTML = `
            <div style="text-align:center; padding:2rem;">
              <div style="font-size:3rem; margin-bottom:1rem;">âœ…</div>
              <h2>Appointment Updated!</h2>
              <div class="actions" style="justify-content:center; margin-top:1.5rem;">
                <button class="btn" id="mBackToSearch">Back to search</button>
              </div>
            </div>
          `;
          container.querySelector('#mBackToSearch').addEventListener('click', () => renderModifyFlow(container));
        })
        .withFailureHandler(err => {
          modal.remove();
          container.innerHTML = `<p class="error">Server error updating appointment.</p>`;
          console.error(err);
        })
        .apiUpdateAppointment(row.id, payload, SCHEDULER(), chosenTransport);
    });
  }

  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // Small helpers
  function csvToArray(s) {
    return (s || '').split(',').map(x => x.trim()).filter(Boolean);
  }
  function safe(v){ return (v==null?'':String(v).replace(/"/g,'&quot;')); }
  function radio(name, val, checked){ return `<label><input type="radio" name="${name}" value="${val}" ${checked?'checked':''}> ${val}</label>`; }
  function getStatesOptions(current) {
    const list = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'];
    return list.map(s => `<option ${current===s?'selected':''}>${s}</option>`).join('');
  }
})();
</script>