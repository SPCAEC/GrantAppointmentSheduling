<script>
(function () {
  const { $, SCHEDULER, sectionTitle } = window.SPCA || {};
  
  // Public Entry
  window.renderCancelFlow = function(container) {
    // Identity Check
    if (typeof getSchedulerName === 'function' && !getSchedulerName()) {
      if (typeof showWhoAreYouScreen === 'function') {
        return showWhoAreYouScreen(container, () => renderCancelFlow(container));
      }
    }

    // FIX: Ensure title is correct (in case "Who are you?" overwrote it)
    if (sectionTitle) sectionTitle.textContent = 'Cancel Appointment';

    renderSearch(container);
  };

  // 1. Search Screen
  function renderSearch(container) {
    container.innerHTML = `
        <div class="schedule-step">
        <h2>Find an Appointment to Cancel</h2>
        <div class="grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.75rem;">
            
            <div class="field">
              <label>Date (MM/DD/YYYY)</label>
              <div style="display:flex; align-items:center; gap:8px;">
                <input id="cDate" type="text" placeholder="MM/DD/YYYY" maxlength="10">
                <div style="position:relative; width:32px; height:32px; flex-shrink:0;">
                   <input id="cDatePicker" type="date" 
                          style="position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%; z-index:2;">
                   <button class="btn secondary" style="width:100%; height:100%; padding:0; display:flex; align-items:center; justify-content:center;">
                     üìÖ
                   </button>
                </div>
              </div>
            </div>

            <div class="field">
              <label>Client Name</label>
              <input id="cClient" type="text" placeholder="First, Last, or First Last">
            </div>
            <div class="field">
              <label>Pet Name</label>
              <input id="cPet" type="text" placeholder="e.g., Max">
            </div>
        </div>
        <div class="actions">
            <button id="cSearchBtn" class="btn">Search</button>
            <button id="cClearBtn" class="btn secondary">Clear</button>
        </div>
        <div id="cResults" style="margin-top:1rem;"></div>
        </div>
    `;

    const cDate = container.querySelector('#cDate');
    const cDatePicker = container.querySelector('#cDatePicker');
    const cClient = container.querySelector('#cClient');
    const cPet = container.querySelector('#cPet');
    const results = container.querySelector('#cResults');
    const searchBtn = container.querySelector('#cSearchBtn');

    // ‚îÄ‚îÄ‚îÄ 1. Date Logic (Auto-Format & Picker) ‚îÄ‚îÄ‚îÄ
    
    // A. Sync Picker -> Text
    cDatePicker.addEventListener('change', () => {
      if (cDatePicker.value) {
        const [y, m, d] = cDatePicker.value.split('-');
        cDate.value = `${m}/${d}/${y}`;
      }
    });

    // B. Typing Logic (12082025 -> 12/08/2025)
    cDate.addEventListener('input', (e) => {
      let v = e.target.value.replace(/\D/g, ''); 
      if (v.length >= 5) v = `${v.slice(0,2)}/${v.slice(2,4)}/${v.slice(4,8)}`;
      else if (v.length >= 3) v = `${v.slice(0,2)}/${v.slice(2)}`;
      e.target.value = v;
    });

    // C. Pad Logic on Blur
    const normalizeDate = () => {
      const raw = cDate.value.trim();
      if (!raw) return;
      const parts = raw.split('/');
      if (parts.length === 3) {
        let m = parts[0];
        let d = parts[1];
        let y = parts[2];
        if (m.length === 1) m = '0' + m;
        if (d.length === 1) d = '0' + d;
        if (y.length === 2) y = '20' + y;
        cDate.value = `${m}/${d}/${y}`;
      }
    };
    cDate.addEventListener('change', normalizeDate);
    cDate.addEventListener('blur', normalizeDate);

    // ‚îÄ‚îÄ‚îÄ 2. Trigger Search on Enter ‚îÄ‚îÄ‚îÄ
    [cDate, cClient, cPet].forEach(input => {
      input.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') searchBtn.click();
      });
    });

    // ‚îÄ‚îÄ‚îÄ 3. Search Button Listener ‚îÄ‚îÄ‚îÄ
    searchBtn.addEventListener('click', () => {
      normalizeDate(); // Ensure format before sending
      results.innerHTML = `<div class="spinner"></div>`;
      
      google.script.run
        .withSuccessHandler(res => {
          if (!res || !res.ok) {
            results.innerHTML = `<p class="error">${res?.error || 'Search failed.'}</p>`;
            return;
          }
          renderResults(container, results, res.rows || []);
        })
        .apiSearchAppointments({
          date: cDate.value.trim(),
          client: cClient.value.trim(),
          pet: cPet.value.trim()
        });
    });

    // ‚îÄ‚îÄ‚îÄ 4. Clear Button ‚îÄ‚îÄ‚îÄ
    container.querySelector('#cClearBtn').addEventListener('click', () => {
      cDate.value = '';
      cDatePicker.value = ''; // Clear picker too
      cClient.value = '';
      cPet.value = '';
      results.innerHTML = '';
    });
  }

  // 2. Results
  function renderResults(container, target, rows) {
    target.innerHTML = '';
    if (!rows.length) {
      target.innerHTML = `<p style="opacity:.7;">No appointments found.</p>`;
      return;
    }

    const grid = document.createElement('div');
    grid.className = 'card-grid';
    target.appendChild(grid);

    rows.forEach(r => {
      // Logic: Can only cancel "Scheduled" or "Reserved"
      // AND must be future date
      const isCancellable = r.editable && (r.status === 'Scheduled' || r.status === 'Reserved');
      
      const card = document.createElement('div');
      card.className = 'card';
      if (!isCancellable) card.style.opacity = 0.6;

      card.innerHTML = `
        <div style="font-weight:600; margin-bottom:4px;">${r.firstName} ${r.lastName} ‚Äî ${r.petName}</div>
        <div>${r.date} ${r.time}</div>
        <div>Status: <strong>${r.status}</strong></div>
        <div style="font-size:.85rem; opacity:.65;">ID: ${r.id}</div>
        ${!isCancellable ? `<div style="margin-top:.5rem; color:#92400e; font-size:0.9rem; background:#fffbea; padding:4px;">Not cancellable</div>` : ``}
      `;

      if (isCancellable) {
        card.style.cursor = 'pointer';
        card.addEventListener('click', () => showCancelModal(container, r));
      }
      grid.appendChild(card);
    });
  }

  // 3. Cancel Modal
  function showCancelModal(container, row) {
    // Remove existing
    document.querySelectorAll('.modal').forEach(m => m.remove());

    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="modal-content" style="border-top: 6px solid #dc2626;">
        <h2 style="color:#b91c1c;">Cancel Appointment</h2>
        <div style="text-align:left; background:#f9fafb; padding:1rem; border-radius:8px; margin-bottom:1rem;">
          <p><strong>Client:</strong> ${row.firstName} ${row.lastName}</p>
          <p><strong>Pet:</strong> ${row.petName}</p>
          <p><strong>Slot:</strong> ${row.date} at ${row.time}</p>
        </div>
        
        <div class="field" style="text-align:left;">
          <label>Reason for Cancellation <span style="color:red">*</span></label>
          <select id="cancelReason">
            <option value="">‚Äî Select Reason ‚Äî</option>
            <option>No longer interested</option>
            <option>Found alternate vet or clinic</option>
            <option>Pet Deceased</option>
            <option>No longer has animal</option>
            <option>Changed mind</option>
          </select>
        </div>

        <p style="font-size:0.9rem; color:#666; margin-top:1rem;">
          This will release the slot back to "Available" and clear all client data.
        </p>

        <div class="actions">
          <button id="btnConfirmCancel" class="btn" style="background:#dc2626;" disabled>Confirm Cancellation</button>
          <button id="btnExitCancel" class="btn secondary">Back</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);

    const select = modal.querySelector('#cancelReason');
    const confirm = modal.querySelector('#btnConfirmCancel');

    select.addEventListener('change', () => {
      confirm.disabled = !select.value;
    });

    modal.querySelector('#btnExitCancel').addEventListener('click', () => modal.remove());

    confirm.addEventListener('click', () => {
      confirm.classList.add('loading');
      const reason = select.value;
      const user = window.getSchedulerName ? window.getSchedulerName() : 'Staff';

      google.script.run
        .withSuccessHandler(res => {
          modal.remove();
          if (!res || !res.ok) {
            alert('Error: ' + (res?.error || 'Failed to cancel'));
            return;
          }
          // Success Screen
          container.innerHTML = `
            <div style="text-align:center; padding:3rem;">
              <div style="font-size:4rem;">üóëÔ∏è</div>
              <h2>Appointment Cancelled & Released</h2>
              <p>The slot is now Available for booking.</p>
              <div class="actions" style="justify-content:center; margin-top:2rem;">
                <button class="btn" onclick="window.renderCancelFlow(document.querySelector('#view-cancel'))">Return to Search</button>
              </div>
            </div>
          `;
        })
        .withFailureHandler(err => {
          modal.remove();
          alert('Server error: ' + err);
        })
        .apiCancelAppointment(row.id, reason, user);
    });
  }

})();
</script>