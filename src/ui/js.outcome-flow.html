<script>
(function () {
  const { $, sectionTitle } = window.SPCA || {};

  // â”€â”€â”€ PUBLIC ENTRY POINT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.renderOutcomeFlow = function(container) {
    if(sectionTitle) sectionTitle.textContent = 'Log Appointment Outcome';
    renderSearch(container);
  };

  // â”€â”€â”€ SEARCH SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderSearch(container) {
    container.innerHTML = `
      <div class="schedule-step">
        <h2>Find Appointment</h2>
        <div class="grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.75rem;">
            
            <div class="field">
              <label>Date</label>
              <div style="display:flex; align-items:center; gap:8px;">
                <input id="oDate" type="text" placeholder="MM/DD/YYYY" maxlength="10">
                <div style="position:relative; width:32px; height:32px; flex-shrink:0;">
                   <input id="oDatePicker" type="date" 
                          style="position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%; z-index:2;">
                   <button class="btn secondary" style="width:100%; height:100%; padding:0; display:flex; align-items:center; justify-content:center;">
                     ğŸ“…
                   </button>
                </div>
              </div>
            </div>

            <div class="field"><label>Client</label><input id="oClient" type="text"></div>
            <div class="field"><label>Pet</label><input id="oPet" type="text"></div>
        </div>
        <div class="actions">
            <button id="oSearchBtn" class="btn">Search</button>
            <button id="oClearBtn" class="btn secondary">Clear</button>
        </div>
        <div id="oResults" style="margin-top:1rem;"></div>
      </div>
    `;

    const results = container.querySelector('#oResults');
    const dateInput = container.querySelector('#oDate');
    const datePicker = container.querySelector('#oDatePicker');

    // â”€â”€â”€ 1. Date Logic (Auto-Format & Picker) â”€â”€â”€
    
    // A. Sync Picker -> Text
    datePicker.addEventListener('change', () => {
      if (datePicker.value) {
        // Picker returns YYYY-MM-DD, we need MM/DD/YYYY
        const [y, m, d] = datePicker.value.split('-');
        dateInput.value = `${m}/${d}/${y}`;
      }
    });

    // B. Typing Logic (12082025 -> 12/08/2025)
    dateInput.addEventListener('input', (e) => {
      let v = e.target.value.replace(/\D/g, ''); // strip non-digits
      if (v.length >= 5) v = `${v.slice(0,2)}/${v.slice(2,4)}/${v.slice(4,8)}`;
      else if (v.length >= 3) v = `${v.slice(0,2)}/${v.slice(2)}`;
      e.target.value = v;
    });

    // C. Pad Logic on Blur (1/1/25 -> 01/01/2025)
    const normalizeDate = () => {
      const raw = dateInput.value.trim();
      if (!raw) return;
      const parts = raw.split('/');
      if (parts.length === 3) {
        let m = parts[0];
        let d = parts[1];
        let y = parts[2];
        
        // Pad Single Digits
        if (m.length === 1) m = '0' + m;
        if (d.length === 1) d = '0' + d;
        
        // Handle Short Year (25 -> 2025)
        if (y.length === 2) y = '20' + y;
        
        dateInput.value = `${m}/${d}/${y}`;
      }
    };
    dateInput.addEventListener('change', normalizeDate);
    dateInput.addEventListener('blur', normalizeDate);


    // â”€â”€â”€ 2. Search Action â”€â”€â”€
    container.querySelector('#oSearchBtn').addEventListener('click', () => {
      normalizeDate(); // Ensure format is perfect before sending
      
      results.innerHTML = `<div class="spinner"></div>`;
      google.script.run
        .withSuccessHandler(res => {
          if (!res || !res.ok) { 
            results.innerHTML = `<p class="error">${res?.error || 'Error searching.'}</p>`; 
            return; 
          }
          renderResults(container, results, res.rows || []);
        })
        .withFailureHandler(err => {
          results.innerHTML = `<p class="error">Server error.</p>`;
        })
        .apiSearchAppointments({
          date: dateInput.value.trim(),
          client: container.querySelector('#oClient').value.trim(),
          pet: container.querySelector('#oPet').value.trim()
        }, true); 
    });
    
    // Clear Action
    container.querySelector('#oClearBtn').addEventListener('click', () => {
        dateInput.value = '';
        datePicker.value = '';
        container.querySelector('#oClient').value = '';
        container.querySelector('#oPet').value = '';
        results.innerHTML = '';
    });
  }

  // â”€â”€â”€ RESULTS RENDERER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderResults(container, target, rows) {
    target.innerHTML = '';
    if(!rows.length) { 
        target.innerHTML = `<p style="opacity:0.6; margin-top:1rem;">No appointments found.</p>`; 
        return; 
    }
    
    const grid = document.createElement('div');
    grid.className = 'card-grid';
    target.appendChild(grid);

    rows.forEach(r => {
      const card = document.createElement('div');
      card.className = 'card';
      const isAvailable = (r.status === 'Available');
      const statusStyle = isAvailable 
        ? 'color:var(--success); background:#dcfce7; padding:2px 6px; border-radius:4px;' 
        : 'color:var(--fg);';

      card.innerHTML = `
        <div style="font-weight:600; margin-bottom:0.25rem;">
           ${isAvailable ? 'Empty Slot' : r.firstName + ' ' + r.lastName} 
           ${isAvailable ? '' : 'â€” ' + r.petName}
        </div>
        <div>${r.date} ${r.time}</div>
        <div>Status: <strong style="${statusStyle}">${r.status}</strong></div>
        <div style="font-size:0.8rem; opacity:0.6; margin-top:0.25rem;">${r.id}</div>
      `;
      card.style.cursor = 'pointer';
      card.addEventListener('click', () => renderOutcomeForm(container, r));
      grid.appendChild(card);
    });
  }

  // â”€â”€â”€ OUTCOME FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderOutcomeForm(container, row) {
    const isAvailable = (row.status === 'Available');
    const displayTitle = isAvailable ? `Block Off Slot` : `Appointment Outcome`;

    // Button Logic
    let buttonsHtml = '';
    if (isAvailable) {
        buttonsHtml = `
           <button class="btn outcome-opt" data-val="DO NOT USE" style="background:#fff; border:2px solid #dc2626; color:#dc2626; height:90px; font-size:1.1rem; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:0.5rem; transition:all 0.2s;">
             <span style="font-size:2rem;">ğŸ›‘</span> Block Off
           </button>
        `;
    } else {
        buttonsHtml = `
           <button class="btn outcome-opt" data-val="Completed" style="background:#fff; border:2px solid #ddd; color:#333; height:90px; font-size:1.1rem; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:0.5rem; transition:all 0.2s;">
             <span style="font-size:2rem;">âœ…</span> Completed
           </button>
           <button class="btn outcome-opt" data-val="No Show" style="background:#fff; border:2px solid #ddd; color:#333; height:90px; font-size:1.1rem; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:0.5rem; transition:all 0.2s;">
             <span style="font-size:2rem;">ğŸš«</span> No Show
           </button>
        `;
    }

    container.innerHTML = `
      <div class="schedule-step">
        <h2>${displayTitle}</h2>
        
        <div style="background:#f8fafc; padding:1rem; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:1.5rem;">
           <strong>${row.firstName} ${row.lastName}</strong> ${row.petName ? 'with <strong>'+row.petName+'</strong>' : ''}<br>
           ${row.date} at ${row.time}<br>
           <span style="font-size:0.9rem; color:#64748b;">ID: ${row.id}</span>
        </div>

        <h3 id="selectLabel">Select Action</h3>
        <div class="outcome-buttons" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:1rem; margin-bottom:1.5rem;">
           ${buttonsHtml}
        </div>

        <div id="noteSection" class="hidden">
           
           <div id="originalNotesPanel" class="hidden" style="margin-bottom:1.5rem; background:#fff7ed; border:1px solid #fed7aa; padding:1rem; border-radius:8px;">
              <label style="font-weight:700; color:#c2410c; display:block; margin-bottom:0.5rem;">Original Request Notes:</label>
              <div style="font-style:italic; color:#444;">"${row.notes || 'No notes provided.'}"</div>
              <div style="margin-top:0.75rem; font-size:0.9rem; color:#c2410c; font-weight:600;">
                 âš ï¸ Please ensure your summary below addresses all concerns mentioned above.
              </div>
           </div>

           <label id="noteLabel" style="font-weight:600; display:block; margin-bottom:0.5rem;">Notes</label>
           
           <div class="toolbar" style="background:#f1f5f9; padding:0.5rem; border:1px solid #cbd5e1; border-bottom:none; border-radius:8px 8px 0 0; display:flex; gap:0.5rem;">
             <button type="button" data-cmd="bold" style="font-weight:bold; min-width:30px;">B</button>
             <button type="button" data-cmd="italic" style="font-style:italic; min-width:30px;">I</button>
             <button type="button" data-cmd="underline" style="text-decoration:underline; min-width:30px;">U</button>
             <div style="width:1px; background:#cbd5e1; margin:0 4px;"></div>
             <button type="button" data-cmd="insertUnorderedList">â€¢ List</button>
             <button type="button" data-cmd="insertOrderedList">1. List</button>
           </div>
           
           <div id="richEditor" contenteditable="true" 
                style="min-height:150px; background:#fff; border:1px solid #cbd5e1; border-radius:0 0 8px 8px; padding:1rem; overflow-y:auto; line-height:1.5;">
           </div>
           
           <div class="actions" style="margin-top:1.5rem;">
             <button id="saveOutcome" class="btn">Save</button>
             <button id="cancelOutcome" class="btn secondary">Cancel</button>
           </div>
        </div>
      </div>
    `;

    let selectedOutcome = '';
    let isNoteRequired = false;
    
    const buttons = container.querySelectorAll('.outcome-opt');
    const noteSection = container.querySelector('#noteSection');
    const origPanel = container.querySelector('#originalNotesPanel');
    const editor = container.querySelector('#richEditor');
    const noteLabel = container.querySelector('#noteLabel');

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        buttons.forEach(b => {
           b.style.borderColor = '#ddd'; 
           b.style.background = '#fff';
           b.style.color = '#333';
           if(b.dataset.val === 'DO NOT USE') b.style.color = '#dc2626';
           b.style.boxShadow = 'none';
        });
        
        btn.style.background = '#f0f9ff';
        btn.style.boxShadow = '0 0 0 2px var(--accent)';
        if(btn.dataset.val === 'DO NOT USE') {
            btn.style.background = '#fef2f2';
            btn.style.boxShadow = '0 0 0 2px #dc2626';
        }

        selectedOutcome = btn.dataset.val;
        noteSection.classList.remove('hidden');
        
        if (selectedOutcome === 'Completed') {
            origPanel.classList.remove('hidden');
            noteLabel.innerHTML = `Summary Note <span style="color:red">*</span>`;
            isNoteRequired = true;
        } else {
            origPanel.classList.add('hidden');
            noteLabel.innerHTML = `Notes (Optional)`;
            isNoteRequired = false;
        }

        if (!editor.innerText.trim()) setTimeout(() => editor.focus(), 100);
      });
    });

    container.querySelectorAll('.toolbar button').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        document.execCommand(btn.dataset.cmd, false, null);
        editor.focus();
      });
    });

    container.querySelector('#saveOutcome').addEventListener('click', () => {
      const textNote = editor.innerText.trim();
      const htmlNote = editor.innerHTML;
      const user = (typeof window.getSchedulerName === 'function') ? window.getSchedulerName() : 'Staff';
      
      if (isNoteRequired && textNote.length < 5) {
          alert("Please provide a summary note addressing the original concerns.");
          editor.focus();
          return;
      }

      const saveBtn = container.querySelector('#saveOutcome');
      saveBtn.classList.add('loading');

      google.script.run
        .withSuccessHandler(res => {
           if(!res || !res.ok) { 
             alert('Error saving: ' + (res?.error || 'Unknown error')); 
             saveBtn.classList.remove('loading'); 
             return; 
           }
           let msg = (selectedOutcome === 'DO NOT USE') ? `Slot has been blocked off.` : `Outcome saved as <strong>${selectedOutcome}</strong>.`;
           container.innerHTML = `
             <div style="text-align:center; padding:3rem;">
               <div style="font-size:4rem; margin-bottom:1rem;">ğŸ’¾</div>
               <h2>Success</h2>
               <p style="color:#64748b; margin-top:0.5rem;">${msg}</p>
               <div class="actions" style="justify-content:center; margin-top:2rem;">
                 <button class="btn" onclick="window.renderOutcomeFlow(document.querySelector('#view-outcome'))">Log Another</button>
               </div>
             </div>
           `;
        })
        .withFailureHandler(err => {
           alert('Server Error: ' + err);
           saveBtn.classList.remove('loading');
        })
        .apiLogOutcome(row.id, selectedOutcome, textNote, htmlNote, user);
    });

    container.querySelector('#cancelOutcome').addEventListener('click', () => {
       renderOutcomeFlow(container);
    });
  }

})();
</script>