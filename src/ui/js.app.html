<script>
document.addEventListener('DOMContentLoaded', () => {
  const $  = sel => document.querySelector(sel);
  const $$ = sel => [...document.querySelectorAll(sel)];

  const header        = $('#appHeader');
  const sectionTitle  = $('#sectionTitle');
  const backBtn       = $('#backBtn');
  const mainMenu      = $('#mainMenu');
  const views         = $$('.sub-view');

  // ───────────────────────────────────────────────
  // Navigation between main tiles and sub-views
  // ───────────────────────────────────────────────
  $$('.tile').forEach(btn => {
    btn.addEventListener('click', () => openView(btn.dataset.view));
  });

  backBtn.addEventListener('click', () => {
    header.classList.add('hidden');
    sectionTitle.textContent = '';
    views.forEach(v => v.classList.add('hidden'));
    mainMenu.classList.remove('hidden');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  function openView(view) {
    mainMenu.classList.add('hidden');
    header.classList.remove('hidden');
    sectionTitle.textContent = viewTitle(view);
    views.forEach(v => v.classList.add('hidden'));
    const target = $(`#view-${view}`);
    target.classList.remove('hidden');

    if (view === 'schedule') renderScheduleFlow(target);
  }

  function viewTitle(view) {
    return {
      schedule: 'Schedule New Appointment',
      modify:   'Modify Existing Appointment',
      cancel:   'Cancel Appointment',
      outcome:  'Log Appointment Outcome'
    }[view] || '';
  }

  // ───────────────────────────────────────────────
  // Schedule Flow
  // ───────────────────────────────────────────────
  function renderScheduleFlow(container) {
    container.innerHTML = `
      <div id="step-type" class="schedule-step">
        <h2>What type of appointment?</h2>
        <div class="option-buttons">
          <button class="btn" data-type="Surgery">Surgery</button>
          <button class="btn" data-type="Wellness">Wellness</button>
        </div>
      </div>

      <div id="step-slots" class="schedule-step hidden">
        <h2>Select an Available Appointment</h2>
        <div id="slotGrid" class="card-grid"></div>
        <div class="actions">
          <button id="showMoreBtn" class="btn secondary">Show 6 More</button>
        </div>
      </div>

      <div id="step-form" class="schedule-step hidden">
        <h2>Client & Pet Information</h2>
        <div id="formFields"></div>
        <div class="actions">
          <button id="continueBtn" class="btn">Continue</button>
        </div>
      </div>

      <div id="step-confirm" class="schedule-step hidden">
        <div class="spinner"></div>
      </div>
    `;

    const stepType    = container.querySelector('#step-type');
    const stepSlots   = container.querySelector('#step-slots');
    const stepForm    = container.querySelector('#step-form');
    const stepConfirm = container.querySelector('#step-confirm');
    const slotGrid    = container.querySelector('#slotGrid');
    const showMoreBtn = container.querySelector('#showMoreBtn');
    const continueBtn = container.querySelector('#continueBtn');

    let selectedType = null;
    let slotsShown   = 6;
    let selectedSlot = null;

    // ─── Step 1: Choose appointment type ──────────────
    stepType.querySelectorAll('button[data-type]').forEach(btn => {
      btn.addEventListener('click', () => {
        selectedType = btn.dataset.type || '';
        if (!selectedType) {
          alert('Please select an appointment type.');
          return;
        }
        console.log('Appointment type selected:', selectedType);
        stepType.classList.add('hidden');
        stepSlots.classList.remove('hidden');
        fetchSlots();
        scrollTop();
      });
    });

    // ─── Fetch available slots ──────────────
    function fetchSlots() {
      if (!selectedType) {
        console.warn('fetchSlots() called without selectedType');
        return;
      }

      slotGrid.innerHTML = `<div class="spinner"></div>`;
      console.log('Calling apiGetAvailableSlots with:', selectedType, slotsShown);

      google.script.run
        .withSuccessHandler(res => {
          console.log('apiGetAvailableSlots response:', res);
          if (!res) {
            slotGrid.innerHTML = `<p class="error">No response from server.</p>`;
            return;
          }
          if (!res.ok) {
            slotGrid.innerHTML = `<p class="error">Error loading slots: ${res.error || 'Unknown error'}</p>`;
            return;
          }
          console.log('Slots array length:', res.slots?.length || 0);
          renderSlots(res.slots || []);
        })
        .withFailureHandler(err => {
          console.error('Fetch slots failed:', err);
          slotGrid.innerHTML = `<p class="error">Server error loading slots.</p>`;
        })
        .apiGetAvailableSlots(selectedType, slotsShown);
    }

    function renderSlots(slots) {
      slotGrid.innerHTML = '';
      if (!slots || !slots.length) {
        slotGrid.innerHTML = `<p>No available appointments found.</p>`;
        return;
      }

      slots.forEach(slot => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div><strong>${selectedType}</strong></div>
          <div>${slot.day} ${slot.date}</div>
          <div>${slot.time}</div>
          <div>Grant: ${slot.grant || '—'}</div>
        `;
        card.addEventListener('click', () => {
          selectedSlot = slot;
          stepSlots.classList.add('hidden');
          stepForm.classList.remove('hidden');
          renderFormFields();
          scrollTop();
        });
        slotGrid.appendChild(card);
      });
    }

    showMoreBtn.addEventListener('click', () => {
      slotsShown += 6;
      fetchSlots();
    });

    // ─── Step 3: Client & Pet Form ──────────────
    function renderFormFields() {
      const f = container.querySelector('#formFields');
      f.innerHTML = `
        <div class="field"><label>First Name</label><input type="text" id="firstName"></div>
        <div class="field"><label>Last Name</label><input type="text" id="lastName"></div>
        <div class="field"><label>Email</label><input type="email" id="email"></div>
        <div class="field"><label>Phone</label><input type="tel" id="phone" placeholder="(###) ###-####"></div>
        <div class="field"><label>Pet Name</label><input type="text" id="petName"></div>
        <div class="field"><label>Species</label>
          <select id="species">
            <option value="">— Select —</option>
            <option value="Canine">Canine</option>
            <option value="Feline">Feline</option>
          </select>
        </div>
      `;
    }

    // ─── Step 4: Continue → Modal → Confirm ──────────────
    continueBtn.addEventListener('click', showTransportModal);

    function scrollTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showTransportModal() {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content">
          <p>Does this client require transportation assistance for this appointment?</p>
          <div class="actions">
            <button class="btn" data-answer="Yes">Yes</button>
            <button class="btn secondary" data-answer="No">No</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      modal.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          const transport = btn.dataset.answer;
          modal.remove();
          bookAppointment(transport);
        });
      });
    }

    function bookAppointment(transport) {
      stepForm.classList.add('hidden');
      stepConfirm.classList.remove('hidden');

      const payload = {
        'First Name': container.querySelector('#firstName').value.trim(),
        'Last Name': container.querySelector('#lastName').value.trim(),
        'Email': container.querySelector('#email').value.trim(),
        'Phone': container.querySelector('#phone').value.trim(),
        'Pet Name': container.querySelector('#petName').value.trim(),
        'Species': container.querySelector('#species').value,
        'Transportation Required': transport
      };

      console.log('Booking appointment payload:', payload, selectedType, selectedSlot);

      google.script.run
        .withSuccessHandler(res => {
          console.log('apiBookAppointment response:', res);
          if (!res) {
            stepConfirm.innerHTML = `<p class="error">No response from server.</p>`;
            return;
          }
          if (!res.ok) {
            stepConfirm.innerHTML = `<p class="error">Booking failed: ${res.error || 'Unknown error'}</p>`;
            return;
          }
          showConfirmation();
        })
        .withFailureHandler(err => {
          console.error('Booking failed:', err);
          stepConfirm.innerHTML = `<p class="error">Server error booking appointment.</p>`;
        })
        .apiBookAppointment(payload, selectedType, selectedSlot.date, selectedSlot.time);
    }

    function showConfirmation() {
      stepConfirm.innerHTML = `
        <h2>Appointment Booked!</h2>
        <div class="actions">
          <button id="bookAnotherBtn" class="btn">Book another for this client</button>
          <button id="doneBtn" class="btn secondary">Done</button>
        </div>
      `;
      container.querySelector('#bookAnotherBtn').addEventListener('click', () => {
        renderScheduleFlow(container);
        scrollTop();
      });
      container.querySelector('#doneBtn').addEventListener('click', () => backBtn.click());
    }
  }
});
</script>