<script>
document.addEventListener('DOMContentLoaded', () => {
  const $  = sel => document.querySelector(sel);
  const $$ = sel => [...document.querySelectorAll(sel)];

  const header = $('#appHeader');
  const sectionTitle = $('#sectionTitle');
  const backBtn = $('#backBtn');
  const mainMenu = $('#mainMenu');
  const views = $$('.sub-view');

  // ──────────────────────────────
  // Navigation
  // ──────────────────────────────
  $$('.tile').forEach(btn => {
    btn.addEventListener('click', () => openView(btn.dataset.view));
  });

  backBtn.addEventListener('click', () => {
    header.classList.add('hidden');
    sectionTitle.textContent = '';
    views.forEach(v => v.classList.add('hidden'));
    mainMenu.classList.remove('hidden');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  function openView(view) {
    mainMenu.classList.add('hidden');
    header.classList.remove('hidden');
    sectionTitle.textContent = viewTitle(view);
    views.forEach(v => v.classList.add('hidden'));

    const target = $(`#view-${view}`);
    target.classList.remove('hidden');

    if (view === 'schedule') renderScheduleFlow(target);
  }

  function viewTitle(view) {
    return {
      schedule: 'Schedule New Appointment',
      modify:   'Modify Existing Appointment',
      cancel:   'Cancel Appointment',
      outcome:  'Log Appointment Outcome'
    }[view] || '';
  }

  // ──────────────────────────────
  // Schedule Flow
  // ──────────────────────────────
  function renderScheduleFlow(container) {
    container.innerHTML = `
      <div id="step-type" class="schedule-step">
        <h2>What type of appointment?</h2>
        <div class="option-buttons">
          <button class="btn" data-type="Surgery">Surgery</button>
          <button class="btn" data-type="Wellness">Wellness</button>
        </div>
      </div>

      <div id="step-slots" class="schedule-step hidden">
        <h2>Select an Available Appointment</h2>
        <div id="slotGrid" class="card-grid"></div>
        <div class="actions">
          <button id="showMoreBtn" class="btn secondary">Show 6 More</button>
        </div>
      </div>

      <div id="step-form" class="schedule-step hidden">
        <h2>Client & Pet Information</h2>
        <div id="formFields"></div>
        <div class="actions">
          <button id="continueBtn" class="btn">Continue</button>
        </div>
      </div>

      <div id="step-confirm" class="schedule-step hidden">
        <div class="spinner"></div>
      </div>
    `;

    const stepType = container.querySelector('#step-type');
    const stepSlots = container.querySelector('#step-slots');
    const stepForm = container.querySelector('#step-form');
    const stepConfirm = container.querySelector('#step-confirm');
    const slotGrid = container.querySelector('#slotGrid');
    const showMoreBtn = container.querySelector('#showMoreBtn');
    const continueBtn = container.querySelector('#continueBtn');

    let selectedType = null;
    let slotsShown = 6;
    let selectedSlot = null;

    // Step 1 → Select type
    stepType.querySelectorAll('button[data-type]').forEach(btn => {
      btn.addEventListener('click', () => {
        selectedType = btn.dataset.type;
        stepType.classList.add('hidden');
        stepSlots.classList.remove('hidden');
        slotGrid.innerHTML = `<div class="spinner"></div>`;
        fetchSlots();
        scrollTop();
      });
    });

    function fetchSlots() {
      google.script.run
        .withSuccessHandler(res => {
          if (!res || !res.ok) {
            slotGrid.innerHTML = `<p class="error">${res?.error || 'Error loading slots.'}</p>`;
            return;
          }
          renderSlots(res.slots || []);
        })
        .withFailureHandler(err => {
          console.error(err);
          slotGrid.innerHTML = `<p class="error">Server error loading slots.</p>`;
        })
        .apiGetAvailableSlots(selectedType, slotsShown);
    }

    function renderSlots(slots) {
      slotGrid.innerHTML = '';
      if (!slots.length) {
        slotGrid.innerHTML = `<p>No available appointments found.</p>`;
        return;
      }
      slots.forEach(slot => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div><strong>${selectedType}</strong></div>
          <div>${slot.day} ${slot.date}</div>
          <div>${slot.time}</div>
          <div>Grant: ${slot.grant || '—'}</div>
          <small style="opacity:0.6;">ID: ${slot.id}</small>
        `;
        card.addEventListener('click', () => {
          selectedSlot = slot;
          stepSlots.classList.add('hidden');
          stepForm.classList.remove('hidden');
          renderFormFields();
          scrollTop();
        });
        slotGrid.appendChild(card);
      });
    }

    showMoreBtn.addEventListener('click', () => {
      slotGrid.innerHTML = `<div class="spinner"></div>`;
      slotsShown += 6;
      fetchSlots();
    });

    // ──────────────────────────────
    // Step 3: Client & Pet Form
    // ──────────────────────────────
    function renderFormFields() {
      const f = container.querySelector('#formFields');
      f.innerHTML = `
        <div class="field"><label>First Name</label><input type="text" id="firstName" required></div>
        <div class="field"><label>Last Name</label><input type="text" id="lastName" required></div>
        <div class="field"><label>Email</label><input type="email" id="email"></div>
        <div class="field"><label>Phone</label><input type="tel" id="phone" placeholder="(###) ###-####" required></div>

        <hr style="margin:1rem 0; border:none; border-top:1px solid #e5e7eb;">
        <h3>Address</h3>
        <div class="field"><label>Street Address</label><input type="text" id="address"></div>
        <div class="field"><label>City</label><input type="text" id="city"></div>
        <div class="field">
          <label>State</label>
          <select id="state">
            ${['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY']
              .map(st => `<option ${st==='NY'?'selected':''}>${st}</option>`).join('')}
          </select>
        </div>
        <div class="field"><label>ZIP Code</label><input type="text" id="zip" maxlength="10" pattern="\\d{5}(-\\d{4})?"></div>

        <hr style="margin:1rem 0; border:none; border-top:1px solid #e5e7eb;">
        <h3>Pet Information</h3>
        <div class="field"><label>Pet Name</label><input type="text" id="petName" required></div>
        <div class="field">
          <label>Species</label>
          <select id="species" required>
            <option value="">— Select —</option>
            <option value="Canine">Canine</option>
            <option value="Feline">Feline</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="field"><label>Primary Breed</label><input type="text" id="breedOne"></div>
        <div class="field"><label>Secondary Breed</label><input type="text" id="breedTwo"></div>
        <div class="field"><label>Color</label><input type="text" id="color"></div>
        <div class="field"><label>Color Pattern</label><input type="text" id="colorPattern"></div>
        <div class="field">
          <label>Sex</label>
          <select id="sex" required>
            <option value="">— Select —</option>
            <option>Male</option>
            <option>Female</option>
          </select>
        </div>
        <div class="field"><label>Age (Years)</label><input type="number" id="age" min="0" step="0.1"></div>
        <div class="field">
          <label>Vaccines Needed</label>
          <select id="vaccines" multiple></select>
          <small>Hold CTRL (Windows) or ⌘ (Mac) to select multiple</small>
        </div>

        <div class="field">
          <label>Additional Services Needed</label>
          <select id="additionalServices" multiple></select>
          <small>Hold CTRL (Windows) or ⌘ (Mac) to select multiple</small>
        </div>

        <div class="field">
          <label>Previous Vet Records?</label>
          <div class="option-buttons">
            <label><input type="radio" name="hasVetRecords" value="Yes"> Yes</label>
            <label><input type="radio" name="hasVetRecords" value="No" checked> No</label>
          </div>
        </div>

        <div class="field">
          <label>Prior Veterinarian Office</label>
          <input type="text" id="vetOffice">
        </div>
        <div class="field"><label>Approx. Weight (lbs)</label><input type="number" id="weight" min="0" step="0.1"></div>
        <div class="field"><label>Additional Notes</label><textarea id="notes" rows="3" placeholder="Any special needs or concerns..."></textarea></div>
      `;

      // --- Auto-format phone number ---
      const phoneInput = container.querySelector('#phone');
      phoneInput.addEventListener('blur', () => {
        const digits = phoneInput.value.replace(/\D/g, '');
        if (digits.length === 10) {
          phoneInput.value = `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
        }
      });

      // --- Dynamic vaccines list ---
      const speciesSelect = container.querySelector('#species');
      const vaccineSelect = container.querySelector('#vaccines');
      google.script.run
        .withSuccessHandler(res => {
          if (!res || !res.ok) return;
          const lists = { canine: res.canine || [], feline: res.feline || [] };
          speciesSelect.addEventListener('change', () => {
            const val = speciesSelect.value;
            let options = [];
            if (val === 'Canine') options = lists.canine;
            else if (val === 'Feline') options = lists.feline;
            vaccineSelect.innerHTML = options.length
              ? options.map(v => `<option>${v}</option>`).join('')
              : `<option value="">— No Vaccines Available —</option>`;
          });
        })
        .apiGetVaccineLists();

      // --- Load Additional Services ---
      google.script.run
        .withSuccessHandler(res => {
          if (!res || !res.ok) return;
          const select = container.querySelector('#additionalServices');
          select.innerHTML = res.services.map(s => `<option>${s}</option>`).join('');
        })
        .apiGetAdditionalServices();
    }

    continueBtn.addEventListener('click', showTransportModal);

    function scrollTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ──────────────────────────────
    // Step 4: Transport & Vet Records Modal
    // ──────────────────────────────
    function showTransportModal() {
      const hasVetRecords = container.querySelector('input[name="hasVetRecords"]:checked')?.value === 'Yes';
      const firstName = container.querySelector('#firstName').value.trim();
      const lastName = container.querySelector('#lastName').value.trim();
      const petName = container.querySelector('#petName').value.trim();
      const clientEmail = container.querySelector('#email').value.trim();

      const modal = document.createElement('div');
      modal.className = 'modal';

      let inner = `
        <div class="modal-content">
          <p>Does this client require transportation assistance for this appointment?</p>
          <div class="actions">
            <button class="btn" data-transport="Yes">Yes</button>
            <button class="btn secondary" data-transport="No">No</button>
          </div>
      `;

      if (hasVetRecords) {
        inner += `
          <hr>
          <p>You indicated the client has previous veterinary records for this pet. 
          If you have them now, please upload. If not, choose “Send Record Request” 
          to email the client an upload link.</p>
          <div class="actions">
            <input type="file" id="recordsUpload" multiple style="display:none;" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            <button id="uploadBtn" class="btn">Upload Previous Records</button>
            <button id="sendRequestBtn" class="btn secondary">Send Record Request</button>
          </div>
          <div id="uploadList" class="upload-list"></div>
        `;
      }

      inner += `</div>`;
      modal.innerHTML = inner;
      document.body.appendChild(modal);

      // ─── Transport Buttons ────────────────────────────
      modal.querySelectorAll('button[data-transport]').forEach(btn => {
        btn.addEventListener('click', () => {
          const transport = btn.dataset.transport;
          modal.dataset.transport = transport;

          // If client has no vet records, book immediately
          if (!hasVetRecords) {
            modal.remove();
            bookAppointment(transport);
          }
        });
      });

      // ─── Upload Records Handler ───────────────────────
      const uploadBtn = modal.querySelector('#uploadBtn');
      if (uploadBtn) {
        uploadBtn.addEventListener('click', () => {
          const input = modal.querySelector('#recordsUpload');
          input.click();

          input.onchange = () => {
            const files = [...input.files];
            if (!files.length) return;

            // Create client/pet folder first
            google.script.run
              .withSuccessHandler(res => {
                if (!res.ok) return alert('Error creating folder.');
                const uploadList = modal.querySelector('#uploadList');
                uploadList.innerHTML = '';

                let completed = 0;
                files.forEach(file => {
                  const row = document.createElement('div');
                  row.className = 'upload-item';
                  row.innerHTML = `<span>${file.name}</span> <span class="spinner small"></span>`;
                  uploadList.appendChild(row);

                  const reader = new FileReader();
                  reader.onload = e => {
                    const base64 = e.target.result.split(',')[1];
                    google.script.run
                      .withSuccessHandler(() => {
                        completed++;
                        row.innerHTML = `<span>${file.name}</span> <span class="status success">✅</span>`;
                        if (completed === files.length) {
                          alert('All files uploaded successfully!');
                          modal.remove();
                          bookAppointment(modal.dataset.transport);
                        }
                      })
                      .withFailureHandler(err => {
                        row.innerHTML = `<span>${file.name}</span> <span class="status error">❌ ${err}</span>`;
                      })
                      .apiUploadVetRecord(file.name, base64, res.folderId);
                  };
                  reader.readAsDataURL(file);
                });
              })
              .apiCreateVetRecordsFolder(firstName, lastName, petName, clientEmail);
          };
        });
      }

      // ─── Send Records Request Handler ─────────────────
      const sendBtn = modal.querySelector('#sendRequestBtn');
      if (sendBtn) {
        sendBtn.addEventListener('click', () => {
          google.script.run
            .withSuccessHandler(res => {
              if (!res.ok) return alert('Error creating folder.');
              google.script.run
                .withSuccessHandler(() => {
                  alert('Upload link sent to client!');
                  modal.remove();
                  bookAppointment(modal.dataset.transport);
                })
                .apiSendVetRecordsRequest(clientEmail, res.url, firstName, petName);
            })
            .apiCreateVetRecordsFolder(firstName, lastName, petName, clientEmail);
        });
      }
    }

    // ──────────────────────────────
    // Step 5: Book Appointment
    // ──────────────────────────────
    function bookAppointment(transport) {
      stepForm.classList.add('hidden');
      stepConfirm.classList.remove('hidden');

      const payload = {
        'First Name': container.querySelector('#firstName').value.trim(),
        'Last Name': container.querySelector('#lastName').value.trim(),
        'Email': container.querySelector('#email').value.trim(),
        'Phone Number': container.querySelector('#phone').value.trim(),
        'Street Address': container.querySelector('#address').value.trim(),
        'City': container.querySelector('#city').value.trim(),
        'State': container.querySelector('#state').value.trim(),
        'ZIP': container.querySelector('#zip').value.trim(),
        'Pet Name': container.querySelector('#petName').value.trim(),
        'Species': container.querySelector('#species').value.trim(),
        'Sex': container.querySelector('#sex').value.trim(),
        'Age': container.querySelector('#age').value.trim(),
        'Breed One': container.querySelector('#breedOne').value.trim(),
        'Breed Two': container.querySelector('#breedTwo').value.trim(),
        'Color': container.querySelector('#color').value.trim(),
        'Color Pattern': container.querySelector('#colorPattern').value.trim(),
        'Vaccines Needed': [...container.querySelector('#vaccines').selectedOptions].map(o => o.value).join(', '),
        'Additional Services': [...container.querySelector('#additionalServices').selectedOptions].map(o => o.value).join(', '),
        'Weight': container.querySelector('#weight').value.trim(),
        'Notes': container.querySelector('#notes').value.trim(),
        'Previous Vet Records': container.querySelector('input[name="hasVetRecords"]:checked')?.value || 'No',
        'Vet Office Name': container.querySelector('#vetOffice').value.trim(),
        'Transportation Required': transport
      };
      console.log('Booking appointment payload:', payload);
      google.script.run
        .withSuccessHandler(res => {
          if (!res || !res.ok) {
            stepConfirm.innerHTML = `<p class="error">Booking failed: ${res?.error || 'Unknown error'}</p>`;
            return;
          }
          showConfirmation();
        })
        .withFailureHandler(err => {
          console.error('Booking failed:', err);
          stepConfirm.innerHTML = `<p class="error">Server error booking appointment.</p>`;
        })
        .apiBookAppointment(payload, selectedType, selectedSlot.date, selectedSlot.time, selectedSlot.id);
    }

    function showConfirmation() {
      stepConfirm.innerHTML = `
        <h2>Appointment Booked!</h2>
        <div class="actions">
          <button id="bookAnotherBtn" class="btn">Book another</button>
          <button id="doneBtn" class="btn secondary">Done</button>
        </div>
      `;
      container.querySelector('#bookAnotherBtn').addEventListener('click', () => renderScheduleFlow(container));
      container.querySelector('#doneBtn').addEventListener('click', () => backBtn.click());
    }
  }
});
</script>