<script>
document.addEventListener('DOMContentLoaded', () => {
  const $  = sel => document.querySelector(sel);
  const $$ = sel => [...document.querySelectorAll(sel)];

  const header       = $('#appHeader');
  const sectionTitle = $('#sectionTitle');
  const backBtn      = $('#backBtn');
  const mainMenu     = $('#mainMenu');
  const views        = $$('.sub-view');

  // ──────────────────────────────
  // Navigation
  // ──────────────────────────────
  $$('.tile').forEach(btn => {
    btn.addEventListener('click', () => openView(btn.dataset.view));
  });

  backBtn.addEventListener('click', () => {
    header.classList.add('hidden');
    sectionTitle.textContent = '';
    views.forEach(v => v.classList.add('hidden'));
    mainMenu.classList.remove('hidden');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  function openView(view) {
    mainMenu.classList.add('hidden');
    header.classList.remove('hidden');
    sectionTitle.textContent = viewTitle(view);
    views.forEach(v => v.classList.add('hidden'));

    const target = $(`#view-${view}`);
    target.classList.remove('hidden');

    if (view === 'schedule') renderScheduleFlow(target);
  }

  function viewTitle(view) {
    return {
      schedule: 'Schedule New Appointment',
      modify:   'Modify Existing Appointment',
      cancel:   'Cancel Appointment',
      outcome:  'Log Appointment Outcome'
    }[view] || '';
  }

  // ──────────────────────────────
  // Schedule Flow
  // ──────────────────────────────
  function renderScheduleFlow(container) {
    container.innerHTML = `
      <div id="step-type" class="schedule-step">
        <h2>What type of appointment?</h2>
        <div class="option-buttons">
          <button class="btn" data-type="Surgery">Surgery</button>
          <button class="btn" data-type="Wellness">Wellness</button>
        </div>
      </div>

      <div id="step-slots" class="schedule-step hidden">
        <h2>Select an Available Appointment</h2>
        <div id="slotGrid" class="card-grid"></div>
        <div class="actions">
          <button id="showMoreBtn" class="btn secondary">Show 6 More</button>
        </div>
      </div>

      <div id="step-form" class="schedule-step hidden">
        <h2>Client & Pet Information</h2>
        <div id="formFields"></div>
        <div class="actions">
          <button id="continueBtn" class="btn">Continue</button>
        </div>
      </div>

      <div id="step-confirm" class="schedule-step hidden">
        <div class="spinner"></div>
      </div>
    `;

    const stepType    = container.querySelector('#step-type');
    const stepSlots   = container.querySelector('#step-slots');
    const stepForm    = container.querySelector('#step-form');
    const stepConfirm = container.querySelector('#step-confirm');
    const slotGrid    = container.querySelector('#slotGrid');
    const showMoreBtn = container.querySelector('#showMoreBtn');
    const continueBtn = container.querySelector('#continueBtn');

    let selectedType = null;
    let slotsShown   = 6;
    let selectedSlot = null;

    // ─── Step 1: Select type ───────────────
    stepType.querySelectorAll('button[data-type]').forEach(btn => {
      btn.addEventListener('click', () => {
        selectedType = btn.dataset.type;
        stepType.classList.add('hidden');
        stepSlots.classList.remove('hidden');
        slotGrid.innerHTML = `<div class="spinner"></div>`;
        fetchSlots();
        scrollTop();
      });
    });

    // ─── Fetch slots ───────────────
    function fetchSlots() {
      google.script.run
        .withSuccessHandler(res => {
          console.log('apiGetAvailableSlots response:', res);

          if (!res) {
            slotGrid.innerHTML = `<p class="error">No response from server.</p>`;
            return;
          }
          if (!res.ok) {
            slotGrid.innerHTML = `<p class="error">Error loading slots: ${res.error || 'Unknown error'}</p>`;
            return;
          }

          if (!res.slots || !res.slots.length) {
            slotGrid.innerHTML = `<p>No available appointments found.</p>`;
            return;
          }

          renderSlots(res.slots);
        })
        .withFailureHandler(err => {
          console.error('Fetch slots failed:', err);
          slotGrid.innerHTML = `<p class="error">Server error loading slots.</p>`;
        })
        .apiGetAvailableSlots(selectedType, slotsShown);
    }

    function renderSlots(slots) {
      slotGrid.innerHTML = '';
      slots.forEach(slot => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div><strong>${selectedType}</strong></div>
          <div>${slot.day} ${slot.date}</div>
          <div>${slot.time}</div>
          <div>Grant: ${slot.grant || '—'}</div>
          <small style="opacity:0.6;">ID: ${slot.id}</small>
        `;
        card.addEventListener('click', () => {
          selectedSlot = slot; // includes .id now
          stepSlots.classList.add('hidden');
          stepForm.classList.remove('hidden');
          renderFormFields();
          scrollTop();
        });
        slotGrid.appendChild(card);
      });
    }

    showMoreBtn.addEventListener('click', () => {
      slotGrid.innerHTML = `<div class="spinner"></div>`;
      slotsShown += 6;
      fetchSlots();
    });

    // ─── Step 3: Form ───────────────
    // ─── Step 3: Client & Pet Form ──────────────
  // ─── Step 3: Client & Pet Form ──────────────
  function renderFormFields() {
    const f = container.querySelector('#formFields');
    f.innerHTML = `
      <div class="field"><label>First Name</label><input type="text" id="firstName" required></div>
      <div class="field"><label>Last Name</label><input type="text" id="lastName" required></div>
      <div class="field"><label>Email</label><input type="email" id="email"></div>
      <div class="field"><label>Phone</label><input type="tel" id="phone" placeholder="(###) ###-####" required></div>

      <hr style="margin:1rem 0; border:none; border-top:1px solid #e5e7eb;">
      <h3>Address</h3>
      <div class="field"><label>Street Address</label><input type="text" id="address"></div>
      <div class="field"><label>City</label><input type="text" id="city"></div>
      <div class="field">
        <label>State</label>
        <select id="state">
          <option value="">— Select —</option>
          <option>NY</option>
          <option>PA</option>
          <option>Other</option>
        </select>
      </div>
      <div class="field"><label>ZIP Code</label><input type="text" id="zip" maxlength="10" pattern="\\d{5}(-\\d{4})?"></div>

      <hr style="margin:1rem 0; border:none; border-top:1px solid #e5e7eb;">
      <h3>Pet Information</h3>
      <div class="field"><label>Pet Name</label><input type="text" id="petName" required></div>
      <div class="field">
        <label>Species</label>
        <select id="species" required>
          <option value="">— Select —</option>
          <option value="Canine">Canine</option>
          <option value="Feline">Feline</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="field"><label>Primary Breed</label><input type="text" id="breedOne"></div>
      <div class="field"><label>Secondary Breed</label><input type="text" id="breedTwo"></div>
      <div class="field"><label>Color</label><input type="text" id="color"></div>
      <div class="field"><label>Color Pattern</label><input type="text" id="colorPattern"></div>
      <div class="field">
        <label>Vaccines Needed</label>
        <select id="vaccines">
          <option value="">— Select Species First —</option>
        </select>
      </div>
      <div class="field"><label>Approx. Weight (lbs)</label><input type="number" id="weight" min="0" step="0.1"></div>
      <div class="field"><label>Additional Notes</label><textarea id="notes" rows="3" placeholder="Any special needs or concerns..."></textarea></div>
    `;

    // --- Auto-format phone number on blur ---
    const phoneInput = container.querySelector('#phone');
    phoneInput.addEventListener('blur', () => {
      const digits = phoneInput.value.replace(/\D/g, '');
      if (digits.length === 10) {
        phoneInput.value = `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
      }
    });

    // --- Dynamic vaccines list based on species ---
    const speciesSelect = container.querySelector('#species');
    const vaccineSelect = container.querySelector('#vaccines');

    // fetch vaccine lists from backend
    google.script.run
      .withSuccessHandler(res => {
        if (!res || !res.ok) return;
        const lists = { canine: res.canine || [], feline: res.feline || [] };

        speciesSelect.addEventListener('change', () => {
          const val = speciesSelect.value;
          let options = [];
          if (val === 'Canine') options = lists.canine;
          else if (val === 'Feline') options = lists.feline;
          else options = [];
          vaccineSelect.innerHTML = options.length
            ? `<option value="">— Select —</option>` + options.map(v => `<option>${v}</option>`).join('')
            : `<option value="">— No Vaccines Available —</option>`;
        });
      })
      .apiGetVaccineLists();
  }

    // ─── Step 4: Continue / Book ───────────────
    continueBtn.addEventListener('click', showTransportModal);

    function scrollTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showTransportModal() {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content">
          <p>Does this client require transportation assistance for this appointment?</p>
          <div class="actions">
            <button class="btn" data-answer="Yes">Yes</button>
            <button class="btn secondary" data-answer="No">No</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      modal.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          const transport = btn.dataset.answer;
          modal.remove();
          bookAppointment(transport);
        });
      });
    }

    function bookAppointment(transport) {
      stepForm.classList.add('hidden');
      stepConfirm.classList.remove('hidden');

      const payload = {
        'First Name': container.querySelector('#firstName').value.trim(),
        'Last Name': container.querySelector('#lastName').value.trim(),
        'Email': container.querySelector('#email').value.trim(),
        'Phone': container.querySelector('#phone').value.trim(),
        'Street Address': container.querySelector('#address').value.trim(),
        'City': container.querySelector('#city').value.trim(),
        'State': container.querySelector('#state').value.trim(),
        'ZIP': container.querySelector('#zip').value.trim(),
        'Pet Name': container.querySelector('#petName').value.trim(),
        'Species': container.querySelector('#species').value.trim(),
        'Breed One': container.querySelector('#breedOne').value.trim(),
        'Breed Two': container.querySelector('#breedTwo').value.trim(),
        'Color': container.querySelector('#color').value.trim(),
        'Color Pattern': container.querySelector('#colorPattern').value.trim(),
        'Vaccines Needed': container.querySelector('#vaccines').value.trim(),
        'Weight': container.querySelector('#weight').value.trim(),
        'Notes': container.querySelector('#notes').value.trim(),
        'Transportation Required': transport
      };

      google.script.run
        .withSuccessHandler(res => {
          if (!res) {
            stepConfirm.innerHTML = `<p class="error">No response from server.</p>`;
            return;
          }
          if (!res.ok) {
            stepConfirm.innerHTML = `<p class="error">Booking failed: ${res.error || 'Unknown error'}</p>`;
            return;
          }
          showConfirmation();
        })
        .withFailureHandler(err => {
          console.error('Booking failed:', err);
          stepConfirm.innerHTML = `<p class="error">Server error booking appointment.</p>`;
        })
        .apiBookAppointment(payload, selectedSlot.id);
    }

    function showConfirmation() {
      stepConfirm.innerHTML = `
        <h2>Appointment Booked!</h2>
        <div class="actions">
          <button id="bookAnotherBtn" class="btn">Book another for this client</button>
          <button id="doneBtn" class="btn secondary">Done</button>
        </div>
      `;
      container.querySelector('#bookAnotherBtn').addEventListener('click', () => {
        renderScheduleFlow(container);
        scrollTop();
      });
      container.querySelector('#doneBtn').addEventListener('click', () => backBtn.click());
    }
  }
});
</script>