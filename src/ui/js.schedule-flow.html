<script>
(function() {
  window.renderScheduleFlow = function(container, preloadedOwner = null) {
    const { backBtn, sectionTitle } = window.SPCA || {};
    if(sectionTitle) sectionTitle.textContent = 'Schedule New Appointment';

    // ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const TX = {
      scheduler: (typeof getSchedulerName === 'function') ? getSchedulerName() : 'Staff',
      type: null,
      slot: null,
      isRogue: false,
      rogueData: {},
      owner: preloadedOwner,
      pet: null,
      originalOwnerState: null
    };

    // ‚îÄ‚îÄ‚îÄ HISTORY STACK FOR NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const stepHistory = [];

    // Custom function to handle forward/backward movement
    function nextStep(currentId, nextId) {
      container.querySelector('#'+currentId).classList.add('hidden');
      container.querySelector('#'+nextId).classList.remove('hidden');
      window.scrollTo({top:0, behavior:'smooth'});
      stepHistory.push(currentId);
      window.SPCA.setBackHandler(() => {
        const prevId = stepHistory.pop();
        container.querySelector('#'+nextId).classList.add('hidden');
        container.querySelector('#'+prevId).classList.remove('hidden');
        if (stepHistory.length === 0) window.SPCA.setBackHandler(null);
      });
    }

    // ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toProperCase(str) {
      if (!str) return '';
      return str.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
    }

    // ‚îÄ‚îÄ‚îÄ TEMPLATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    container.innerHTML = `
      <div id="step-type" class="schedule-step">
        <h2>Appointment Type</h2>
        <div class="option-buttons">
          <button class="btn" data-type="Surgery">Surgery</button>
          <button class="btn" data-type="Wellness">Wellness</button>
        </div>
      </div>

      <div id="step-slots" class="schedule-step hidden">
        <h2>Select Slot</h2>
        <div id="slotGrid" class="card-grid"></div>
        <div class="actions">
          <button id="showMoreBtn" class="btn secondary">Show More</button>
          <button id="rogueBtn" class="btn tertiary" style="border:2px dashed #dc2626; color:#dc2626;">Go Rogue (Create Exception)</button>
        </div>
      </div>

      <div id="step-rogue" class="schedule-step hidden">
        <div style="background:#fff1f2; padding:1rem; border-radius:8px; border:1px solid #dc2626; margin-bottom:1.5rem;">
          <h3 style="color:#b91c1c; margin-top:0;">Exception Details</h3>
          <div class="field"><label>Date (MM/DD/YYYY)</label><input id="rDate" type="text" placeholder="MM/DD/YYYY"></div>
          <div class="grid" style="grid-template-columns:1fr 1fr; gap:1rem; display:grid;">
            <div class="field"><label>Time</label><input id="rTime" type="text" placeholder="09:00"></div>
            <div class="field"><label>AM/PM</label><select id="rAmPm"><option>AM</option><option>PM</option></select></div>
          </div>
        </div>
        <div class="actions"><button id="rNext" class="btn">Next</button></div>
      </div>

      <div id="step-search" class="schedule-step hidden">
        <h2>Find Client</h2>
        <p style="font-size:0.9rem; color:#666;">Search by Phone, Email, or Owner ID.</p>
        <div class="field" style="display:flex; gap:0.5rem;">
          <input id="qSearch" type="text" placeholder="e.g. 716-555-0100 or Smith">
          <button id="btnSearch" class="btn">Search</button>
        </div>
        <div id="searchResults" style="margin-top:1rem;"></div>
        <div class="actions" style="justify-content:flex-start;">
          <button id="btnNewClient" class="btn secondary">Create New Client</button>
        </div>
      </div>

      <div id="step-owner" class="schedule-step hidden">
        <h2 id="lblOwnerStepTitle">Confirm Owner Info</h2>
        <p id="lblOwnerStepSub" class="hidden" style="color:#dc2626; margin-top:-0.5rem; margin-bottom:1rem; font-size:0.9rem; font-weight:600;">All fields required</p> 
        
        <input type="hidden" id="ownerId">
        <div class="grid" style="display:grid; grid-template-columns:1fr 1fr; gap:0.75rem;">
          <div class="field"><label>First Name <span style="color:red">*</span></label><input id="oFirst"></div>
          <div class="field"><label>Last Name <span style="color:red">*</span></label><input id="oLast"></div>
        </div>
        <div class="field"><label>Phone <span style="color:red">*</span></label><input id="oPhone"></div>
        <div class="field"><label>Email <span style="color:red">*</span></label><input id="oEmail"></div>
        <div class="field"><label>Address <span style="color:red">*</span></label><input id="oAddress"></div>
        <div class="grid" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:0.5rem;">
          <div class="field"><label>City <span style="color:red">*</span></label><input id="oCity"></div>
          <div class="field"><label>State <span style="color:red">*</span></label><input id="oState"></div>
          <div class="field"><label>Zip <span style="color:red">*</span></label><input id="oZip"></div>
        </div>
        
        <div id="duplicateWarning" class="hidden" style="margin-top:1.5rem; background:#fff7ed; border:1px solid #c2410c; border-radius:8px; padding:1rem;">
          <h3 style="color:#c2410c; margin-top:0; font-size:1.1rem;">‚ö†Ô∏è Existing Record Found</h3>
          <p style="font-size:0.9rem; margin-bottom:1rem;">We found a client in the database that matches the Phone or Email you entered.</p>
          <div id="dupCard" style="background:#fff; padding:0.75rem; border:1px solid #ddd; border-radius:4px; font-size:0.9rem; color:#555; margin-bottom:1rem;"></div>
          <p style="font-size:0.9rem; color:#444;">
            <strong>Merge Instructions:</strong> Use the form above to modify the client info if needed. 
            When ready, click <strong>Merge Records</strong> below. 
            <br><em style="color:#c2410c;">This will overwrite the existing record with the data above.</em>
          </p>
          <div class="actions" style="justify-content:flex-start; margin-top:0.5rem;">
            <button id="btnMerge" class="btn" style="background:#c2410c; border-color:#c2410c; color:white;">Merge Records</button>
            <button id="btnCancelMerge" class="btn secondary">Cancel</button>
          </div>
        </div>

        <div class="actions" id="defaultOwnerActions">
          <button id="btnSaveOwner" class="btn">Save & Select Pet</button>
        </div>
      </div>

      <div id="step-pet" class="schedule-step hidden">
        <h2>Pet Details</h2>
        <input type="hidden" id="petId">
        <div class="field"><label>Pet Name</label><input id="pName"></div>
        <div class="field"><label>Species</label>
          <select id="pSpecies">
            <option value="">‚Äî Select ‚Äî</option><option>Canine</option><option>Feline</option><option>Other</option>
          </select>
        </div>
        <div class="grid" style="display:grid; grid-template-columns:1fr 1fr; gap:0.75rem;">
          <div class="field"><label>Breed 1</label><input id="pBreed1"></div>
          <div class="field"><label>Breed 2</label><input id="pBreed2"></div>
          <div class="field"><label>Color</label><input id="pColor"></div>
          <div class="field"><label>Pattern</label><input id="pPattern"></div>
          <div class="field"><label>Sex</label><select id="pSex"><option>Male</option><option>Female</option><option>Unknown</option></select></div>
          <div class="field"><label>Spayed/Neutered</label><select id="pFixed"><option>Spayed</option><option>Neutered</option><option>No</option><option>Unknown</option></select></div>
        </div>
        
        <div class="grid" style="display:grid; grid-template-columns:2fr 2fr 3fr; gap:0.75rem;">
          <div class="field">
             <label>Age (Years)</label>
             <input id="pAgeY" type="number" min="0" placeholder="0">
          </div>
          <div class="field">
             <label>(Months)</label>
             <input id="pAgeM" type="number" min="0" max="11" placeholder="0">
          </div>
          <div class="field">
             <label>Weight (Pounds)</label>
             <div style="display:flex; align-items:center;">
                <input id="pWeight" type="number" min="0" style="width:100%;">
                <span style="margin-left:8px; font-size:0.9rem; color:#555;">lbs</span>
             </div>
          </div>
        </div>

        <div class="actions">
          <button id="btnSavePet" class="btn">Save & Continue</button>
        </div>
      </div>

      <div id="step-details" class="schedule-step hidden">
        <h2>Appointment Details</h2>
        <div style="background:#f0f9ff; padding:1rem; border-radius:8px; margin-bottom:1rem; border:1px solid #bae6fd;">
          <strong id="dispType"></strong><br>
          <span id="dispSlot"></span><br>
          Client: <strong id="dispOwner"></strong> | Pet: <strong id="dispPet"></strong>
        </div>
        
        <div class="field">
          <label>Vaccines Needed</label>
          <div id="vaccines" class="option-list"></div>
        </div>
        <div class="field">
          <label>Additional Services</label>
          <div id="services" class="option-list"></div>
        </div>
        <div class="field">
          <label>Previous Vet Records?</label>
          <div class="option-buttons-left">
            <label><input type="radio" name="hasRec" value="Yes"> Yes</label>
            <label><input type="radio" name="hasRec" value="No" checked> No</label>
          </div>
        </div>
        <div class="field"><label>Vet Office</label><input id="aVet"></div>
        
        <div class="field">
           <label>Allergies or Sensitivities?</label>
           <div class="option-buttons-left" style="margin-bottom:0.5rem;">
              <label><input type="radio" name="hasAllergy" value="Yes"> Yes</label>
              <label><input type="radio" name="hasAllergy" value="No" checked> No</label>
           </div>
           <input id="aAllergyText" class="hidden" placeholder="Please specify allergies...">
        </div>

        <div class="field"><label>Notes <span style="color:red">*</span></label><textarea id="aNotes"></textarea></div>
        
        <div class="actions">
          <button id="btnFinalize" class="btn">Finish</button>
        </div>
      </div>

      <div id="step-loading" class="schedule-step hidden"><div class="spinner"></div></div>
    `;

    // ‚îÄ‚îÄ‚îÄ INITIALIZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const dInput = container.querySelector('#rDate');
    const tInput = container.querySelector('#rTime');
    
    dInput.addEventListener('input', (e) => {
      let v = e.target.value.replace(/\D/g, '');
      if (v.length >= 5) v = `${v.slice(0,2)}/${v.slice(2,4)}/${v.slice(4,8)}`;
      else if (v.length >= 3) v = `${v.slice(0,2)}/${v.slice(2)}`;
      e.target.value = v;
    });

    tInput.addEventListener('blur', (e) => {
      let v = e.target.value.replace(/\D/g, ''); 
      if (v.length > 0) {
        if (v.length === 1) v = `0${v}:00`;       
        else if (v.length === 2) v = `${v}:00`;   
        else if (v.length === 3) v = `0${v.slice(0,1)}:${v.slice(1)}`; 
        else if (v.length === 4) v = `${v.slice(0,2)}:${v.slice(2)}`; 
        e.target.value = v;
      }
    });

    // ‚îÄ‚îÄ‚îÄ LOGIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    // Step 1: Type
    container.querySelectorAll('#step-type button').forEach(b => {
      b.addEventListener('click', () => {
        TX.type = b.dataset.type;
        nextStep('step-type', 'step-slots');
        loadSlots();
      });
    });

    // Step 2: Slots
    let slotsCount = 6;
    function loadSlots() {
      const grid = container.querySelector('#slotGrid');
      grid.innerHTML = '<div class="spinner"></div>';
      google.script.run.withSuccessHandler(res => {
        grid.innerHTML = '';
        if(!res.ok || !res.slots.length) { 
          grid.innerHTML = '<p>No slots available.</p>'; 
          return; 
        }
        res.slots.forEach(s => {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div style="font-weight:700; font-size:1.05rem; margin-bottom:0.25rem;">${TX.type}</div>
            <div style="margin-bottom:0.1rem;">${s.day} ${s.date}</div>
            <div style="font-size:1.1rem; font-weight:600; margin-bottom:0.25rem;">${s.time}</div>
            <div style="font-size:0.9rem; color:#444;">Grant: ${s.grant || 'None'}</div>
            <div style="font-size:0.75rem; opacity:0.5; margin-top:0.4rem;">ID: ${s.id}</div>
          `;
          card.onclick = () => {
            TX.slot = s;
            TX.isRogue = false;
            if (TX.owner) {
               populateOwnerForm(TX.owner);
               nextStep('step-slots', 'step-owner');
            } else {
               nextStep('step-slots', 'step-search');
            }
          };
          grid.appendChild(card);
        });
      }).apiGetAvailableSlots(TX.type, slotsCount);
    } 

    container.querySelector('#showMoreBtn').onclick = () => { slotsCount += 6; loadSlots(); };
    
    container.querySelector('#rogueBtn').onclick = () => {
      TX.isRogue = true;
      if (TX.owner) {
         populateOwnerForm(TX.owner);
         nextStep('step-slots', 'step-owner');
      } else {
         nextStep('step-slots', 'step-rogue');
      }
    };

    container.querySelector('#rNext').onclick = () => {
      const d = container.querySelector('#rDate').value;
      const t = container.querySelector('#rTime').value;
      if(!d || !t) return alert('Date/Time required');
      
      const warnModal = document.createElement('div');
      warnModal.className = 'modal';
      warnModal.innerHTML = `
        <div class="modal-content" style="border-top: 6px solid #dc2626;">
          <h2 style="color:#b91c1c;">‚ö†Ô∏è Exception Warning</h2>
          <p>By scheduling this appointment a new slot will be created as a one-time exception for this client.</p>
          <div class="actions">
            <button id="rogueConfirm" class="btn" style="background:#dc2626;">I Understand, Create It</button>
            <button id="rogueCancel" class="btn secondary">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(warnModal);
      warnModal.querySelector('#rogueCancel').onclick = () => warnModal.remove();
      warnModal.querySelector('#rogueConfirm').onclick = () => {
         warnModal.remove();
         TX.rogueData = { date: d, time: t, ampm: container.querySelector('#rAmPm').value };
         if (TX.owner) {
            populateOwnerForm(TX.owner);
            nextStep('step-rogue', 'step-owner');
         } else {
            nextStep('step-rogue', 'step-search');
         }
      };
    };

    // Step 3: Search
    const qSearch = container.querySelector('#qSearch');
    const btnSearch = container.querySelector('#btnSearch');
    qSearch.addEventListener('keyup', (e) => { if (e.key === 'Enter') btnSearch.click(); });

    btnSearch.onclick = () => {
      const sRes = container.querySelector('#searchResults');
      sRes.innerHTML = '<div class="spinner"></div>';
      google.script.run.withSuccessHandler(matches => {
        sRes.innerHTML = '';
        if(!matches.length) { sRes.innerHTML = '<p>No matches found.</p>'; return; }
        if(matches.length === 1) {
            TX.owner = matches[0];
            populateOwnerForm(matches[0]);
            nextStep('step-search', 'step-owner');
            return;
        }
        matches.forEach(m => {
          const row = document.createElement('div');
          row.className = 'card';
          row.style.marginBottom = '0.5rem';
          row.style.cursor = 'pointer';
          row.innerHTML = `<strong>${m.firstName} ${m.lastName}</strong><br>${m.phone}<br>${m.email}<br><small>${m.ownerId}</small>`;
          row.onclick = () => {
            TX.owner = m;
            populateOwnerForm(m);
            nextStep('step-search', 'step-owner');
          };
          sRes.appendChild(row);
        });
      }).apiSearchOwners(qSearch.value);
    };

    container.querySelector('#btnNewClient').onclick = () => {
      TX.owner = null; 
      const searchVal = container.querySelector('#qSearch').value.trim();
      const preFillData = {};
      if (searchVal && searchVal.length > 0) {
        if (searchVal.includes('@')) preFillData['Email'] = searchVal;
        else preFillData['Phone'] = searchVal;
      }
      populateOwnerForm(preFillData, true); 
      nextStep('step-search', 'step-owner');
    };

    // Step 4: Owner Form
    function getOwnerFormData() {
      // üîπ UPDATED: Proper Case Applied
      return {
        'Owner ID': container.querySelector('#ownerId').value,
        'First Name': toProperCase(container.querySelector('#oFirst').value.trim()),
        'Last Name': toProperCase(container.querySelector('#oLast').value.trim()),
        'Phone': container.querySelector('#oPhone').value.trim(),
        'Email': toProperCase(container.querySelector('#oEmail').value.trim()), 
        'Street Address': toProperCase(container.querySelector('#oAddress').value.trim()),
        'City': toProperCase(container.querySelector('#oCity').value.trim()),
        'State': toProperCase(container.querySelector('#oState').value.trim()),
        'Zip Code': container.querySelector('#oZip').value.trim()
      };
    }

    function populateOwnerForm(data, isNew = false) {
      const title = container.querySelector('#lblOwnerStepTitle');
      const sub = container.querySelector('#lblOwnerStepSub');
      if (isNew) { title.textContent = 'Enter Client Info'; sub.classList.remove('hidden'); }
      else { title.textContent = 'Confirm Client Info'; sub.classList.add('hidden'); }

      const ids = ['oFirst','oLast','oPhone','oEmail','oAddress','oCity','oState','oZip','ownerId'];
      ids.forEach(id => container.querySelector('#'+id).value = '');
      
      const val = (k1, k2) => data[k1] || data[k2] || '';
      container.querySelector('#oFirst').value = val('firstName', 'First Name');
      container.querySelector('#oLast').value = val('lastName', 'Last Name');
      container.querySelector('#oPhone').value = val('phone', 'Phone');
      container.querySelector('#oEmail').value = val('email', 'Email');
      container.querySelector('#oAddress').value = val('address', 'Street Address');
      container.querySelector('#oCity').value = val('city', 'City');
      container.querySelector('#oState').value = val('state', 'State');
      container.querySelector('#oZip').value = val('zip', 'Zip Code');
      container.querySelector('#ownerId').value = val('ownerId', 'Owner ID');
      TX.originalOwnerState = JSON.stringify(getOwnerFormData());
    }

    const pInput = container.querySelector('#oPhone');
    pInput.addEventListener('blur', () => {
        const digits = pInput.value.replace(/\D/g, '');
        if (digits.length === 10) pInput.value = `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
    });

    // SAVE / MERGE LOGIC
    function validateOwnerForm() {
      const payload = getOwnerFormData();
      const requiredFields = ['First Name', 'Last Name', 'Phone', 'Email', 'Street Address', 'City', 'State', 'Zip Code'];
      const missing = requiredFields.filter(field => !payload[field]);
      if (missing.length > 0) { alert(`Please fill in all owner fields.\nMissing: ${missing.join(', ')}`); return null; }
      return payload;
    }

    container.querySelector('#btnSaveOwner').onclick = () => {
      const payload = validateOwnerForm();
      if (!payload) return;
      const isExistingClient = !!payload['Owner ID'];
      
      if (isExistingClient && JSON.stringify(payload) === TX.originalOwnerState) {
        TX.owner = { ...payload, ownerId: payload['Owner ID'] };
        showPetModal(payload['Owner ID']);
        return;
      }

      if (!isExistingClient) {
        const btn = container.querySelector('#btnSaveOwner');
        btn.textContent = 'Checking...'; btn.disabled = true;
        google.script.run.withSuccessHandler(phoneMatches => {
          if (phoneMatches.length > 0) {
             presentDuplicateOption(phoneMatches[0], payload); resetSaveBtn();
          } else {
             google.script.run.withSuccessHandler(emailMatches => {
                if (emailMatches.length > 0) {
                   presentDuplicateOption(emailMatches[0], payload); resetSaveBtn();
                } else {
                   executeOwnerSave(payload, false);
                }
             }).apiSearchOwners(payload['Email']);
          }
        }).apiSearchOwners(payload['Phone']);
        return; 
      }
      executeOwnerSave(payload, true);
    };

    function resetSaveBtn() {
       const btn = container.querySelector('#btnSaveOwner');
       btn.textContent = 'Save & Select Pet'; btn.disabled = false;
    }

    let pendingMergeId = null; 
    function presentDuplicateOption(foundRecord, currentFormData) {
       pendingMergeId = foundRecord.ownerId;
       const warn = container.querySelector('#duplicateWarning');
       const actions = container.querySelector('#defaultOwnerActions');
       warn.classList.remove('hidden'); actions.classList.add('hidden');
       container.querySelector('#dupCard').innerHTML = `
         <strong>Existing Record (ID: ${foundRecord.ownerId})</strong><br>
         ${foundRecord.firstName} ${foundRecord.lastName}<br>
         ${foundRecord.phone} | ${foundRecord.email}<br>
         ${foundRecord.address}, ${foundRecord.city}
       `;
    }

    container.querySelector('#btnMerge').onclick = () => {
       const payload = validateOwnerForm();
       if (!payload || !pendingMergeId) return;
       payload['Owner ID'] = pendingMergeId;
       executeOwnerSave(payload, true); 
    };

    container.querySelector('#btnCancelMerge').onclick = () => {
       container.querySelector('#duplicateWarning').classList.add('hidden');
       container.querySelector('#defaultOwnerActions').classList.remove('hidden');
       pendingMergeId = null;
    };

    function executeOwnerSave(payload, treatAsExisting) {
       const btn = treatAsExisting ? container.querySelector('#btnMerge') : container.querySelector('#btnSaveOwner');
       if(btn) { btn.textContent = 'Saving...'; btn.disabled = true; }

       google.script.run.withSuccessHandler(id => {
          if(btn) { btn.textContent = treatAsExisting ? 'Merge Records' : 'Save & Select Pet'; btn.disabled = false; }
          container.querySelector('#ownerId').value = id;
          payload['Owner ID'] = id;
          TX.originalOwnerState = JSON.stringify(payload);
          TX.owner = { ...payload, ownerId: id };
          container.querySelector('#duplicateWarning').classList.add('hidden');
          container.querySelector('#defaultOwnerActions').classList.remove('hidden');
          if (treatAsExisting) showPetModal(id);
          else { TX.pet = null; populatePetForm({}); nextStep('step-owner', 'step-pet'); }
       }).apiUpsertOwner(payload, TX.scheduler);
    }

    // Step 5: Pet Modal
    function showPetModal(ownerId) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width:600px;">
          <h2>Select Pet</h2>
          <div id="petList" class="card-grid"></div>
          <div class="actions">
            <button id="btnAddPet" class="btn secondary">+ Add New Pet</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      const list = modal.querySelector('#petList');
      list.innerHTML = '<div class="spinner"></div>';

      google.script.run.withSuccessHandler(pets => {
        list.innerHTML = '';
        if(!pets.length) list.innerHTML = '<p>No active pets found.</p>';
        pets.forEach(p => {
          const details = [p.breed, p.sex, p.color].filter(x => x && String(x).trim() !== '').join(' ‚Ä¢ ');
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div style="font-size:1.1rem;"><strong>${p.name}</strong> <span style="font-size:0.9rem; color:#666;">(${p.species})</span></div>
            <div style="color:#444; margin-top:0.25rem;">${details}</div>
            <div style="margin-top:0.75rem; border-top:1px solid #eee; padding-top:0.5rem;">
               <button class="btn-sm-status btn secondary" style="font-size:0.8rem; padding: 4px 10px;">Update Status</button>
            </div>
            <div class="status-edit hidden" style="margin-top:0.5rem; background:#f9fafb; padding:8px; border-radius:4px; border:1px solid #eee;">
               <div style="margin-bottom:4px; font-weight:600; font-size:0.85rem;">Mark as:</div>
               <select class="pStat" style="width:100%; margin-bottom:0.5rem; padding:4px;"><option>Rehomed</option><option>Deceased</option></select>
               <input class="pNote" placeholder="Note (optional)" style="width:100%; margin-bottom:0.5rem; padding:4px; box-sizing:border-box;">
               <div style="text-align:right;">
                  <button class="btn-save-stat btn" style="font-size:0.8rem; padding:4px 12px; background:#dc2626; border-color:#dc2626;">Confirm Change</button>
               </div>
            </div>
          `;
          card.addEventListener('click', (e) => {
             if(e.target.closest('.status-edit') || e.target.classList.contains('btn-sm-status')) return;
             TX.pet = p;
             modal.remove();
             populatePetForm(p);
             nextStep('step-owner', 'step-pet');
          });
          const statBtn = card.querySelector('.btn-sm-status');
          const statPanel = card.querySelector('.status-edit');
          const saveStat = card.querySelector('.btn-save-stat');
          statBtn.onclick = (e) => { e.stopPropagation(); statPanel.classList.toggle('hidden'); };
          saveStat.onclick = (e) => {
             e.stopPropagation();
             const newStat = card.querySelector('.pStat').value;
             const note = card.querySelector('.pNote').value;
             saveStat.textContent = 'Saving...'; saveStat.disabled = true;
             google.script.run.withSuccessHandler(() => {
                card.style.opacity = '0.5'; card.style.pointerEvents = 'none';
                card.innerHTML = `<div style="padding:1rem; text-align:center; color:#dc2626;"><strong>Marked as ${newStat}</strong></div>`;
             }).apiUpdatePetStatus(p.petId, newStat, note, TX.scheduler);
          };
          list.appendChild(card);
        });
      }).apiGetOwnerPets(ownerId);

      modal.querySelector('#btnAddPet').onclick = () => {
         TX.pet = null; modal.remove(); populatePetForm({}); nextStep('step-owner', 'step-pet');
      };
    }

    // Step 6: Pet Form
    function populatePetForm(p) {
      const ids = ['petId','pName','pSpecies','pBreed1','pBreed2','pColor','pPattern','pSex','pFixed','pAgeY','pAgeM','pWeight'];
      ids.forEach(id => { const el = container.querySelector('#'+id); if(el) el.value = ''; });

      if(p.petId) container.querySelector('#petId').value = p.petId;
      if(p.name) container.querySelector('#pName').value = p.name;
      if(p.species) container.querySelector('#pSpecies').value = p.species;
      if(p.breed) container.querySelector('#pBreed1').value = p.breed;
      if(p.breed2) container.querySelector('#pBreed2').value = p.breed2; 
      if(p.color) container.querySelector('#pColor').value = p.color;
      if(p.pattern) container.querySelector('#pPattern').value = p.pattern;
      if(p.sex) container.querySelector('#pSex').value = p.sex;
      if(p.fixed) container.querySelector('#pFixed').value = p.fixed;

      // üîπ UPDATED: Parse Age & Weight
      if (p.age) {
        const matches = p.age.match(/\d+/g);
        if (matches) {
            if (matches.length > 0) container.querySelector('#pAgeY').value = matches[0];
            if (matches.length > 1) container.querySelector('#pAgeM').value = matches[1];
        } else {
            container.querySelector('#pAgeY').value = p.age.replace(/\D/g, '');
        }
      }
      if (p.weight) {
        container.querySelector('#pWeight').value = String(p.weight).replace(/[^\d.]/g, '');
      }
    }

    container.querySelector('#btnSavePet').onclick = () => {
      // üîπ UPDATED: Proper Case & Age Logic
      const y = container.querySelector('#pAgeY').value || '0';
      const m = container.querySelector('#pAgeM').value || '0';
      const w = container.querySelector('#pWeight').value;

      const payload = {
        'Pet ID': container.querySelector('#petId').value,
        'Owner ID': TX.owner.ownerId,
        'Pet Name': toProperCase(container.querySelector('#pName').value.trim()),
        'Species': toProperCase(container.querySelector('#pSpecies').value),
        'Primary Breed': toProperCase(container.querySelector('#pBreed1').value.trim()),
        'Secondary Breed': toProperCase(container.querySelector('#pBreed2').value.trim()),
        'Color': toProperCase(container.querySelector('#pColor').value.trim()),
        'Color Pattern': toProperCase(container.querySelector('#pPattern').value.trim()),
        'Sex': container.querySelector('#pSex').value,
        'Altered': container.querySelector('#pFixed').value,
        'Age': `${y} years, ${m} months`,
        'Weight': w ? `${w} pounds` : ''
      };

      const btn = container.querySelector('#btnSavePet');
      btn.textContent = 'Saving...'; btn.disabled = true;
      google.script.run.withSuccessHandler(id => {
         TX.pet = { ...payload, petId: id };
         prepDetails();
         nextStep('step-pet', 'step-details');
      }).apiUpsertPet(payload, TX.scheduler);
    };

    // Step 7: Details
    function prepDetails() {
      container.querySelector('#dispType').textContent = TX.type;
      if(TX.isRogue) container.querySelector('#dispSlot').textContent = `EXCEPTION: ${TX.rogueData.date} @ ${TX.rogueData.time}`;
      else container.querySelector('#dispSlot').textContent = `${TX.slot.day} ${TX.slot.date} @ ${TX.slot.time}`;
      container.querySelector('#dispOwner').textContent = TX.owner['First Name'] + ' ' + TX.owner['Last Name'];
      container.querySelector('#dispPet').textContent = TX.pet['Pet Name'];

      google.script.run.withSuccessHandler(res => {
         const opts = (TX.pet['Species'] === 'Canine') ? res.canine : (TX.pet['Species'] === 'Feline' ? res.feline : []);
         container.querySelector('#vaccines').innerHTML = opts.length ? opts.map(v => `<label class="radio-option"><input type="checkbox" name="vaccine" value="${v}"> ${v}</label>`).join('') : '<p>No vaccines available</p>';
      }).apiGetVaccineLists();

      google.script.run.withSuccessHandler(res => {
         container.querySelector('#services').innerHTML = res.services.map(s => `<label class="radio-option"><input type="checkbox" name="service" value="${s}"> ${s}</label>`).join('');
      }).apiGetAdditionalServices();
    }

    // üîπ UPDATED: Allergy Toggle Logic
    container.querySelectorAll('input[name="hasAllergy"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            const txt = container.querySelector('#aAllergyText');
            if (e.target.value === 'Yes') {
                txt.classList.remove('hidden'); txt.focus();
            } else {
                txt.classList.add('hidden'); txt.value = '';
            }
        });
    });

    container.querySelector('#btnFinalize').onclick = () => {
       const notes = container.querySelector('#aNotes').value.trim();
       if (!notes) { alert('Please add a note to this appointment before finishing.'); container.querySelector('#aNotes').focus(); return; }
       showTransportModal();
    };

    // Step 8: Transport Modal
    function showTransportModal() {
      const hasRec = container.querySelector('input[name="hasRec"]:checked')?.value === 'Yes';
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content">
          <p>Does this client require transportation assistance?</p>
          <div class="actions transport-actions"><button class="btn secondary transportBtn" data-val="Yes">Yes</button><button class="btn secondary transportBtn" data-val="No">No</button></div>
          <hr class="divider">
          ${hasRec ? `<p>Previous records indicated. Please upload or request.</p>
            <div class="actions record-actions">
              <input type="file" id="recordsUpload" multiple style="display:none;">
              <button id="uploadBtn" class="btn secondary recordBtn">Upload</button>
              <button id="sendRequestBtn" class="btn secondary recordBtn">Request</button>
              <button id="remindLaterBtn" class="btn secondary recordBtn">Remind</button>
            </div><div id="modalToast"></div>` : ``}
        </div>`;
      document.body.appendChild(modal);

      let transport = null;
      const toast = (m,k) => { const t = modal.querySelector('#modalToast'); if(t){t.textContent=m;t.className=k;} };

      modal.querySelectorAll('.transportBtn').forEach(b => {
         b.onclick = () => {
            modal.querySelectorAll('.transportBtn').forEach(x => { x.classList.remove('selected'); x.classList.add('secondary'); });
            b.classList.remove('secondary'); b.classList.add('selected');
            transport = b.dataset.val;
            if(!hasRec) { modal.remove(); doBook(transport); }
         };
      });

      if(hasRec) {
          const highlight = (id) => modal.querySelectorAll('.recordBtn').forEach(b => { if(b.id===id) {b.classList.add('selected'); b.classList.remove('secondary');} else {b.classList.add('secondary'); b.classList.remove('selected');} });
          modal.querySelector('#uploadBtn').onclick = () => {
              highlight('uploadBtn');
              const input = modal.querySelector('#recordsUpload'); input.click();
              input.onchange = () => {
                 const files = [...input.files]; if(!files.length) return;
                 google.script.run.withSuccessHandler(res => {
                    if(!res.ok) return toast('Folder error','error');
                    let done=0;
                    files.forEach(f => {
                       const reader = new FileReader();
                       reader.onload = e => {
                          google.script.run.withSuccessHandler(() => {
                             done++; if(done===files.length) { toast('Uploaded!','success'); setTimeout(() => { modal.remove(); doBook(transport); }, 1000); }
                          }).apiUploadVetRecord(f.name, e.target.result.split(',')[1], res.folderId);
                       };
                       reader.readAsDataURL(f);
                    });
                 }).apiCreateVetRecordsFolder(TX.owner['First Name'], TX.owner['Last Name'], TX.pet['Pet Name'], TX.owner['Email']);
              };
          };
          modal.querySelector('#sendRequestBtn').onclick = () => {
             highlight('sendRequestBtn');
             modal.querySelector('#sendRequestBtn').textContent = 'Sending...';
             google.script.run.withSuccessHandler(res => { if(res.ok) { toast('Sent!','success'); setTimeout(() => { modal.remove(); doBook(transport); }, 1000); } else toast('Error','error'); }).apiSendVetRecordsRequest(TX.owner['Email'], '', TX.owner['First Name'], TX.pet['Pet Name']);
          };
          modal.querySelector('#remindLaterBtn').onclick = () => {
             highlight('remindLaterBtn');
             modal.querySelector('#remindLaterBtn').textContent = 'Sending...';
             google.script.run.withSuccessHandler(res => { if(res.ok) { toast('Reminder set!','success'); setTimeout(() => { modal.remove(); doBook(transport); }, 1000); } }).apiSendVetRecordReminder(TX.scheduler, TX.pet['Pet Name'], TX.slot ? TX.slot.date : TX.rogueData.date);
          };
      }
    }

    // Step 9: Book
    function doBook(transport) {
       container.querySelector('#step-loading').classList.remove('hidden');
       container.querySelector('#step-details').classList.add('hidden');

       // üîπ UPDATED: Allergy Logic
       const allergyChoice = container.querySelector('input[name="hasAllergy"]:checked')?.value || 'No';
       const allergyDetail = container.querySelector('#aAllergyText').value.trim();
       const finalAllergy = (allergyChoice === 'Yes' && allergyDetail) ? allergyDetail : 'None Known';

       const payload = {
          'Owner ID': TX.owner.ownerId,
          'Pet ID': TX.pet.petId,
          // üîπ UPDATED: Proper Case
          'First Name': toProperCase(TX.owner['First Name']),
          'Last Name': toProperCase(TX.owner['Last Name']),
          'Phone Number': TX.owner['Phone'],
          'Email': toProperCase(TX.owner['Email']),
          'Address': toProperCase(TX.owner['Street Address']),
          'Street Address': toProperCase(TX.owner['Street Address']),
          'City': toProperCase(TX.owner['City']),
          'State': toProperCase(TX.owner['State']),
          'Zip Code': TX.owner['Zip Code'],
          
          'Pet Name': toProperCase(TX.pet['Pet Name']),
          'Species': toProperCase(TX.pet['Species']),
          'Breed One': toProperCase(TX.pet['Primary Breed']),
          'Breed Two': toProperCase(TX.pet['Secondary Breed']),
          'Color': toProperCase(TX.pet['Color']),
          'Color Pattern': toProperCase(TX.pet['Color Pattern']),
          'Sex': TX.pet['Sex'],
          'Spayed or Neutered': TX.pet['Altered'],
          'Age': TX.pet['Age'], 
          'Weight': TX.pet['Weight'],

          'Transportation Needed': transport,
          'Notes': container.querySelector('#aNotes').value,
          'Vet Office Name': toProperCase(container.querySelector('#aVet').value.trim()),
          'Allergies or Sensitivities': finalAllergy,
          
          'Vaccines Needed': [...container.querySelectorAll('input[name="vaccine"]:checked')].map(el => el.value).join(', '),
          'Additional Services': [...container.querySelectorAll('input[name="service"]:checked')].map(el => el.value).join(', '),
          'Previous Vet Records': container.querySelector('input[name="hasRec"]:checked')?.value || 'No'
       };

       if(TX.isRogue) {
          payload['Date'] = TX.rogueData.date;
          payload['Time'] = TX.rogueData.time;
          payload['AM or PM'] = TX.rogueData.ampm;
          payload['Appointment Type'] = TX.type;
          payload['Scheduled By'] = TX.scheduler;
          
          google.script.run.withSuccessHandler(finish).apiCreateRogueAppointment(payload);
       } else {
          google.script.run.withSuccessHandler(finish).apiBookAppointment(
             payload, TX.type, TX.slot.date, TX.slot.time, TX.slot.id, TX.scheduler
          );
       }
    }

    function finish() {
       container.querySelector('#step-loading').classList.add('hidden');
       container.innerHTML = `
          <div style="text-align:center; padding:2rem;">
             <h2>Success!</h2>
             <p>Appointment booked successfully.</p>
             <div class="actions">
               <button class="btn" id="btnBookNext">Book Another for this Client</button>
               <button class="btn secondary" id="btnReturnHome">Return Home</button>
             </div>
          </div>
       `;
       
       // Handle "Book Another"
       const currentOwner = TX.owner;
       container.querySelector('#btnBookNext').onclick = () => {
          // Re-enter flow with the same owner data pre-loaded
          renderScheduleFlow(container, currentOwner);
       };

       // Handle "Return Home" (Full Refresh)
       container.querySelector('#btnReturnHome').onclick = () => {
          // Force a full reload of the web app
          window.top.location.reload();
       };
    }
  };
})();
</script>