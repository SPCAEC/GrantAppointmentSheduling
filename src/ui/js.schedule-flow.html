<script>
function renderScheduleFlow(container) {
  const { getClientCache, setClientCache, clearClientCache, backBtn, sectionTitle } = window.SPCA;
  sectionTitle.textContent = 'Schedule New Appointment';

  // ─── STATE ───────────────────────────────────────────
  let selectedType = null;
  let slotsShown = 6;
  let selectedSlot = null;
  let isRogueMode = false; // New State Flag

  // ─── TEMPLATE SKELETON ───────────────────────────────
  container.innerHTML = `
    <div id="step-type" class="schedule-step">
      <h2>What type of appointment?</h2>
      <div class="option-buttons">
        <button class="btn" data-type="Surgery">Surgery</button>
        <button class="btn" data-type="Wellness">Wellness</button>
      </div>
    </div>

    <div id="step-slots" class="schedule-step hidden">
      <h2>Select an Available Appointment</h2>
      <div id="slotGrid" class="card-grid"></div>
      <div class="actions">
        <button id="showMoreBtn" class="btn secondary">Show 6 More</button>
        <button id="rogueBtn" class="btn tertiary" style="border: 2px dashed #dc2626; color: #dc2626;">Go Rogue (Create Exception)</button>
      </div>
    </div>

    <div id="step-form" class="schedule-step hidden">
      <h2 id="formTitle">Client & Pet Information</h2>
      
      <div id="rogueFields" class="hidden" style="background:#fff1f2; padding:1rem; border-radius:8px; border:1px solid #dc2626; margin-bottom:1.5rem;">
        <h3 style="color:#b91c1c; margin-top:0;">Exception Details</h3>
        <div class="field">
           <label>Appointment Date (MM/DD/YYYY)</label>
           <input type="text" id="rogueDate" placeholder="MM/DD/YYYY">
        </div>
        <div class="grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
           <div class="field">
             <label>Time</label>
             <input type="text" id="rogueTime" placeholder="09:00">
           </div>
           <div class="field">
             <label>AM/PM</label>
             <select id="rogueAmPm">
               <option selected>AM</option>
               <option>PM</option>
             </select>
           </div>
        </div>
      </div>

      <div id="formFields"></div>
      <div class="actions">
        <button id="continueBtn" class="btn">Continue</button>
      </div>
    </div>

    <div id="step-confirm" class="schedule-step hidden">
      <div class="spinner"></div>
    </div>
  `;

  // ─── DOM ELEMENTS ────────────────────────────────────
  const stepType = container.querySelector('#step-type');
  const stepSlots = container.querySelector('#step-slots');
  const stepForm = container.querySelector('#step-form');
  const stepConfirm = container.querySelector('#step-confirm');
  const slotGrid = container.querySelector('#slotGrid');
  const showMoreBtn = container.querySelector('#showMoreBtn');
  const rogueBtn = container.querySelector('#rogueBtn');
  const continueBtn = container.querySelector('#continueBtn');
  const rogueFields = container.querySelector('#rogueFields');

  // ─── STEP 1: SELECT TYPE ─────────────────────────────
  stepType.querySelectorAll('button[data-type]').forEach(btn => {
    btn.addEventListener('click', () => {
      selectedType = btn.dataset.type;
      isRogueMode = false; // Reset
      stepType.classList.add('hidden');
      stepSlots.classList.remove('hidden');
      slotGrid.innerHTML = `<div class="spinner"></div>`;
      fetchSlots();
      scrollTop();
    });
  });

  // ─── STEP 2: SLOT SELECTION / GO ROGUE ───────────────
  
  function fetchSlots() {
    google.script.run
      .withSuccessHandler(res => {
        if (!res || !res.ok) {
          slotGrid.innerHTML = `<p class="error">${res?.error || 'Error loading slots.'}</p>`;
          return;
        }
        renderSlots(res.slots || []);
      })
      .withFailureHandler(err => {
        console.error(err);
        slotGrid.innerHTML = `<p class="error">Server error loading slots.</p>`;
      })
      .apiGetAvailableSlots(selectedType, slotsShown);
  }

  function renderSlots(slots) {
    slotGrid.innerHTML = '';
    if (!slots.length) {
      slotGrid.innerHTML = `<p>No available appointments found.</p>`;
    }
    slots.forEach(slot => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div><strong>${selectedType}</strong></div>
        <div>${slot.day} ${slot.date}</div>
        <div>${slot.time}</div>
        <div>Grant: ${slot.grant || '—'}</div>
        <small style="opacity:0.6;">ID: ${slot.id}</small>
      `;
      card.addEventListener('click', () => {
        selectedSlot = slot;
        isRogueMode = false;
        goToForm();
      });
      slotGrid.appendChild(card);
    });
  }

  showMoreBtn.addEventListener('click', () => {
    slotGrid.innerHTML = `<div class="spinner"></div>`;
    slotsShown += 6;
    fetchSlots();
  });

  // GO ROGUE Handler
  rogueBtn.addEventListener('click', () => {
    isRogueMode = true;
    selectedSlot = null;
    goToForm();
  });

  function goToForm() {
    stepSlots.classList.add('hidden');
    stepForm.classList.remove('hidden');
    
    // Toggle Rogue UI elements
    if (isRogueMode) {
      rogueFields.classList.remove('hidden');
      container.querySelector('#formTitle').textContent = `Creating Exception (${selectedType})`;
      setupRogueFormatters();
    } else {
      rogueFields.classList.add('hidden');
      container.querySelector('#formTitle').textContent = 'Client & Pet Information';
    }

    renderFormFields();
    scrollTop();
  }

  function setupRogueFormatters() {
    const dInput = container.querySelector('#rogueDate');
    const tInput = container.querySelector('#rogueTime');

    // Simple Date formatter MM/DD/YYYY
    dInput.addEventListener('input', (e) => {
      let v = e.target.value.replace(/\D/g, '');
      if (v.length >= 5) v = `${v.slice(0,2)}/${v.slice(2,4)}/${v.slice(4,8)}`;
      else if (v.length >= 3) v = `${v.slice(0,2)}/${v.slice(2)}`;
      e.target.value = v;
    });

    // Time formatter ##:##
    tInput.addEventListener('blur', (e) => {
      let v = e.target.value.replace(/\D/g, ''); // strip non-digits
      if (v.length > 0) {
        if (v.length === 1) v = `0${v}:00`;       // 9 -> 09:00
        else if (v.length === 2) v = `${v}:00`;   // 10 -> 10:00
        else if (v.length === 3) v = `0${v.slice(0,1)}:${v.slice(1)}`; // 930 -> 09:30
        else if (v.length === 4) v = `${v.slice(0,2)}:${v.slice(2)}`; // 1030 -> 10:30
        e.target.value = v;
      }
    });
  }

  // ─── STEP 3: CLIENT FORM RENDER ──────────────────────
  function renderFormFields() {
    const f = container.querySelector('#formFields');
    const cached = getClientCache();

    f.innerHTML = `
      <div class="field"><label>First Name</label><input type="text" id="firstName" required value="${cached['First Name']||''}"></div>
      <div class="field"><label>Last Name</label><input type="text" id="lastName" required value="${cached['Last Name']||''}"></div>
      <div class="field"><label>Email</label><input type="email" id="email" value="${cached['Email']||''}"></div>
      <div class="field"><label>Phone</label><input type="tel" id="phone" placeholder="(###) ###-####" required value="${cached['Phone Number']||''}"></div>

      <hr class="divider">
      <h3>Address</h3>
      <div class="field"><label>Address</label><input type="text" id="address" value="${cached['Address']||''}"></div>
      <div class="field"><label>City</label><input type="text" id="city" value="${cached['City']||''}"></div>
      <div class="field">
        <label>State</label>
        <select id="state">
          ${['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY']
            .map(st => `<option ${ (cached['State'] ? cached['State']===st : st==='NY') ? 'selected':''}>${st}</option>`).join('')}
        </select>
      </div>
      <div class="field"><label>Zip Code</label><input type="text" id="zip" maxlength="10" pattern="\\d{5}(-\\d{4})?" value="${cached['Zip Code']||''}"></div>

      <hr class="divider">
      <h3>Pet Information</h3>
      <div class="field"><label>Pet Name</label><input type="text" id="petName" required></div>
      <div class="field">
        <label>Species</label>
        <select id="species" required>
          <option value="">— Select —</option>
          <option value="Canine">Canine</option>
          <option value="Feline">Feline</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="field"><label>Primary Breed</label><input type="text" id="breedOne"></div>
      <div class="field"><label>Secondary Breed</label><input type="text" id="breedTwo"></div>
      <div class="field"><label>Color</label><input type="text" id="color"></div>
      <div class="field"><label>Color Pattern</label><input type="text" id="colorPattern"></div>
      <div class="field">
        <label>Sex</label>
        <select id="sex" required>
          <option value="">— Select —</option>
          <option>Male</option>
          <option>Female</option>
        </select>
      </div>
      <div class="field"><label>Spayed or Neutered</label>
        <select id="altered">
          <option value="">— Select —</option>
          <option>Spayed</option>
          <option>Neutered</option>
          <option>No</option>
          <option>Unknown</option>
        </select>
      </div>
      <div class="field"><label>Age</label><input type="text" id="age" placeholder="e.g., 2 years or 8 months"></div>

      <div class="field">
        <label>Vaccines Needed</label>
        <div id="vaccines" class="option-list"></div>
      </div>

      <div class="field">
        <label>Additional Services Needed</label>
        <div id="additionalServices" class="option-list"></div>
      </div>

      <div class="field">
        <label>Previous Vet Records?</label>
        <div class="option-buttons-left">
          <label><input type="radio" name="hasVetRecords" value="Yes"> Yes</label>
          <label><input type="radio" name="hasVetRecords" value="No" checked> No</label>
        </div>
      </div>

      <div class="field">
        <label>Vet Office Name</label>
        <input type="text" id="vetOffice">
      </div>

      <div class="field"><label>Allergies or Sensitivities</label>
        <input type="text" id="allergies" placeholder="None known">
      </div>

      <div class="field"><label>Approx. Weight (lbs)</label><input type="number" id="weight" min="0" step="0.1"></div>
      <div class="field"><label>Additional Notes</label><textarea id="notes" rows="3" placeholder="Any special needs or concerns..."></textarea></div>
    `;

    // Phone formatting
    const phoneInput = container.querySelector('#phone');
    phoneInput.addEventListener('blur', () => {
      const digits = phoneInput.value.replace(/\D/g, '');
      if (digits.length === 10) {
        phoneInput.value = `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
      }
    });

    // Vaccines dynamic list
    const speciesSelect = container.querySelector('#species');
    const vaccineList = container.querySelector('#vaccines');
    google.script.run
      .withSuccessHandler(res => {
        if (!res || !res.ok) return;
        const lists = { canine: res.canine || [], feline: res.feline || [] };

        const renderVaccines = (val) => {
          let options = [];
          if (val === 'Canine') options = lists.canine;
          else if (val === 'Feline') options = lists.feline;
          vaccineList.innerHTML = options.length
            ? options.map(v => `
                <label class="radio-option">
                  <input type="checkbox" name="vaccine" value="${v}"> ${v}
                </label>
              `).join('')
            : `<p style="opacity:.6; margin:0;">— No Vaccines Available —</p>`;
        };

        if (cached['Species']) {
          speciesSelect.value = cached['Species'];
          renderVaccines(cached['Species']);
        }

        speciesSelect.addEventListener('change', () => renderVaccines(speciesSelect.value));
      })
      .apiGetVaccineLists();

    // Additional Services list
    google.script.run
      .withSuccessHandler(res => {
        if (!res || !res.ok) return;
        const containerEl = container.querySelector('#additionalServices');
        containerEl.innerHTML = res.services.map(s => `
          <label class="radio-option">
            <input type="checkbox" name="service" value="${s}"> ${s}
          </label>
        `).join('');
      })
      .apiGetAdditionalServices();
  }

  continueBtn.addEventListener('click', () => {
    // If Rogue Mode, we validate date/time first
    if (isRogueMode) {
        const d = container.querySelector('#rogueDate').value;
        const t = container.querySelector('#rogueTime').value;
        if (!d || !t) {
            alert("Please enter a valid Date and Time for this exception appointment.");
            return;
        }
    }
    showTransportModal(); 
  });

  function scrollTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // ─── STEP 4: TRANSPORT & VET RECORDS MODAL ───────────
  function showTransportModal() {
    const hasVetRecords = container.querySelector('input[name="hasVetRecords"]:checked')?.value === 'Yes';
    const firstName = container.querySelector('#firstName').value.trim();
    const lastName = container.querySelector('#lastName').value.trim();
    const petName = container.querySelector('#petName').value.trim();
    const clientEmail = container.querySelector('#email').value.trim();

    const modal = document.createElement('div');
    modal.className = 'modal';

    let inner = `
      <div class="modal-content">
        <p>Does this client require transportation assistance for this appointment?</p>
        <div class="actions transport-actions">
          <button class="btn transportBtn" data-transport="Yes">Yes</button>
          <button class="btn transportBtn" data-transport="No">No</button>
        </div>
        <hr class="divider">
        ${hasVetRecords ? `
          <p>You indicated the client has previous veterinary records for this pet. If you have them now, please upload. If not, choose “Send Record Request” to email the client an upload link.</p>
          <div class="actions">
            <input type="file" id="recordsUpload" multiple style="display:none;" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            <button id="uploadBtn" class="btn" disabled>Upload Previous Records</button>
            <button id="sendRequestBtn" class="btn secondary" disabled>Send Record Request</button>
            <button id="remindLaterBtn" class="btn tertiary" disabled>Remind Me Later</button>
          </div>
          <div id="uploadList" class="upload-list"></div>
          <div id="modalToast"></div>
        ` : ``}
      </div>
    `;
    modal.innerHTML = inner;
    document.body.appendChild(modal);

    const toast = modal.querySelector('#modalToast');
    const setToast = (msg, kind='') => {
      if (!toast) return;
      toast.className = kind==='success' ? 'success-message' : 'error';
      toast.textContent = msg;
      if (kind) setTimeout(()=> toast.textContent='', 3000);
    };

    // Transport buttons
    const transportButtons = modal.querySelectorAll('.transportBtn');
    const enableRecordButtons = () => {
      modal.querySelectorAll('#uploadBtn,#sendRequestBtn,#remindLaterBtn').forEach(b => b && b.removeAttribute('disabled'));
    };
    
    transportButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        transportButtons.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        const transport = btn.dataset.transport;
        modal.dataset.transport = transport;

        if (!hasVetRecords) {
          // Proceed immediately if no records to deal with
          modal.remove();
          // CHECK IF ROGUE
          if (isRogueMode) showRogueWarning(transport);
          else bookAppointment(transport);
        } else {
          enableRecordButtons();
        }
      });
    });

    // Upload Records
    const uploadBtn = modal.querySelector('#uploadBtn');
    if (uploadBtn) {
      uploadBtn.addEventListener('click', () => {
        if (!modal.dataset.transport) {
          setToast('Please select Transportation (Yes or No) first.');
          return;
        }
        const input = modal.querySelector('#recordsUpload');
        input.click();

        input.onchange = () => {
          const files = [...input.files];
          if (!files.length) return;

          const uploadList = modal.querySelector('#uploadList');
          const prepRow = document.createElement('div');
          prepRow.className = 'upload-item';
          prepRow.innerHTML = `<span>Preparing upload…</span> <span class="spinner small"></span>`;
          uploadList.appendChild(prepRow);

          google.script.run
            .withSuccessHandler(res => {
              prepRow.remove();
              if (!res.ok) { setToast('Error creating folder.', 'error'); return; }

              let completed = 0;
              files.forEach(file => {
                const row = document.createElement('div');
                row.className = 'upload-item';
                row.innerHTML = `<span>${file.name}</span> <span class="spinner small"></span>`;
                uploadList.appendChild(row);

                const reader = new FileReader();
                reader.onload = e => {
                  const base64 = e.target.result.split(',')[1];
                  google.script.run
                    .withSuccessHandler(() => {
                      completed++;
                      row.innerHTML = `<span>${file.name}</span> <span class="status success">Uploaded</span>`;
                      if (completed === files.length) {
                        setToast('All files uploaded successfully!', 'success');
                        setTimeout(() => {
                          modal.remove();
                          if (isRogueMode) showRogueWarning(modal.dataset.transport);
                          else bookAppointment(modal.dataset.transport);
                        }, 600);
                      }
                    })
                    .withFailureHandler(err => {
                      row.innerHTML = `<span>${file.name}</span> <span class="status error">Upload failed</span>`;
                      console.error(err);
                    })
                    .apiUploadVetRecord(file.name, base64, res.folderId);
                };
                reader.readAsDataURL(file);
              });
            })
            .withFailureHandler(err => {
              prepRow.remove();
              setToast('Error preparing upload.', 'error');
              console.error(err);
            })
            .apiCreateVetRecordsFolder(firstName, lastName, petName, clientEmail);
        };
      });
    }

    // Send Records Request
    const sendBtn = modal.querySelector('#sendRequestBtn');
    if (sendBtn) {
      sendBtn.addEventListener('click', () => {
        if (!modal.dataset.transport) {
          setToast('Please select Transportation (Yes or No) first.');
          return;
        }
        sendBtn.classList.add('loading');

        google.script.run
          .withSuccessHandler(res => {
            sendBtn.classList.remove('loading');
            if (!res.ok) {
              setToast(res.error || 'Error sending email.', 'error');
              return;
            }
            setToast('Upload link sent to client!', 'success');
            setTimeout(() => {
              modal.remove();
              if (isRogueMode) showRogueWarning(modal.dataset.transport);
              else bookAppointment(modal.dataset.transport);
            }, 600);
          })
          .withFailureHandler(err => {
            sendBtn.classList.remove('loading');
            setToast('Failed to send email.', 'error');
            console.error(err);
          })
          .apiSendVetRecordsRequest(clientEmail, '', firstName, petName);
      });
    }

    // Remind Me Later
    const remindBtn = modal.querySelector('#remindLaterBtn');
    if (remindBtn) {
      remindBtn.addEventListener('click', () => {
        if (!modal.dataset.transport) {
          setToast('Please select Transportation (Yes or No) first.');
          return;
        }
        const scheduler = (typeof getSchedulerName === 'function') ? getSchedulerName() : '';
        const pet = petName;
        // Construct appointment string. If Rogue, use input fields. If Slot, use selectedSlot
        let apptCard = '';
        if (isRogueMode) {
             const d = container.querySelector('#rogueDate').value;
             const t = container.querySelector('#rogueTime').value;
             const ap = container.querySelector('#rogueAmPm').value;
             apptCard = `${d} at ${t} ${ap} (Exception/Rogue: ${selectedType})`;
        } else {
             apptCard = `${selectedSlot.day} ${selectedSlot.date} at ${selectedSlot.time} (${selectedType})`;
        }

        remindBtn.classList.add('loading');

        google.script.run
          .withSuccessHandler(res => {
            remindBtn.classList.remove('loading');
            if (!res || !res.ok) {
              setToast(res?.error || 'Reminder failed to send.', 'error');
              return;
            }
            setToast('Reminder sent to scheduler!', 'success');
            setTimeout(() => {
              modal.remove();
              if (isRogueMode) showRogueWarning(modal.dataset.transport);
              else bookAppointment(modal.dataset.transport);
            }, 600);
          })
          .withFailureHandler(err => {
            remindBtn.classList.remove('loading');
            setToast('Server error sending reminder.', 'error');
            console.error(err);
          })
          .apiSendVetRecordReminder(scheduler, pet, apptCard);
      });
    }
  }

  // ─── ROGUE WARNING MODAL ─────────────────────────────
  function showRogueWarning(transport) {
    const warnModal = document.createElement('div');
    warnModal.className = 'modal';
    warnModal.innerHTML = `
      <div class="modal-content" style="border-top: 6px solid #dc2626;">
        <h2 style="color:#b91c1c;">⚠️ Exception Warning</h2>
        <p>By scheduling this appointment a new slot will be created as a one-time exception for this client.</p>
        <p><strong>Please only continue if Lipsey or the Infirmary has already approved this date/time.</strong></p>
        <div class="actions">
          <button id="rogueConfirm" class="btn" style="background:#dc2626;">I Understand, Create It</button>
          <button id="rogueCancel" class="btn secondary">Cancel</button>
        </div>
      </div>
    `;
    document.body.appendChild(warnModal);

    warnModal.querySelector('#rogueCancel').addEventListener('click', () => {
      warnModal.remove(); 
      // Returns user to form, no data loss
    });

    warnModal.querySelector('#rogueConfirm').addEventListener('click', () => {
      warnModal.remove();
      bookRogueAppointment(transport);
    });
  }

  // ─── STEP 5: BOOK APPOINTMENT ────────────────────────
  
  function collectPayload(transport) {
    const allergies = (container.querySelector('#allergies').value || '').trim() || 'None known';
    return {
      'First Name': container.querySelector('#firstName').value.trim(),
      'Last Name': container.querySelector('#lastName').value.trim(),
      'Email': container.querySelector('#email').value.trim(),
      'Phone Number': container.querySelector('#phone').value.trim(),
      'Address': container.querySelector('#address').value.trim(),
      'City': container.querySelector('#city').value.trim(),
      'State': container.querySelector('#state').value.trim(),
      'Zip Code': container.querySelector('#zip').value.trim(),
      'Pet Name': container.querySelector('#petName').value.trim(),
      'Species': container.querySelector('#species').value.trim(),
      'Sex': container.querySelector('#sex').value.trim(),
      'Spayed or Neutered': container.querySelector('#altered').value.trim(),
      'Age': container.querySelector('#age').value.trim(),
      'Breed One': container.querySelector('#breedOne').value.trim(),
      'Breed Two': container.querySelector('#breedTwo').value.trim(),
      'Color': container.querySelector('#color').value.trim(),
      'Color Pattern': container.querySelector('#colorPattern').value.trim(),
      'Vaccines Needed': [...container.querySelectorAll('input[name="vaccine"]:checked')].map(el => el.value).join(', '),
      'Additional Services': [...container.querySelectorAll('input[name="service"]:checked')].map(el => el.value).join(', '),
      'Allergies or Sensitivities': allergies,
      'Weight': container.querySelector('#weight').value.trim(),
      'Notes': container.querySelector('#notes').value.trim(),
      'Previous Vet Records': container.querySelector('input[name="hasVetRecords"]:checked')?.value || 'No',
      'Vet Office Name': container.querySelector('#vetOffice').value.trim(),
      'Transportation Needed': (transport === 'Yes' ? 'Yes' : 'No')
    };
  }

  // Normal Booking
  function bookAppointment(transport) {
    stepForm.classList.add('hidden');
    stepConfirm.classList.remove('hidden');

    const payload = collectPayload(transport);

    // Save client portion to session cache for “Book another…”
    setClientCache(payload); 

    const scheduler = (typeof getSchedulerName === 'function') ? getSchedulerName() : '';

    google.script.run
      .withSuccessHandler(res => {
        if (!res || !res.ok) {
          stepConfirm.innerHTML = `<p class="error">Booking failed: ${res?.error || 'Unknown error'}</p>`;
          return;
        }
        showConfirmation();
      })
      .withFailureHandler(err => {
        console.error('Booking failed:', err);
        stepConfirm.innerHTML = `<p class="error">Server error booking appointment.</p>`;
      })
      .apiBookAppointment(
        payload,
        selectedType,
        selectedSlot.date,
        selectedSlot.time,
        selectedSlot.id,
        scheduler
      );
  }

  // Rogue Booking
  function bookRogueAppointment(transport) {
    stepForm.classList.add('hidden');
    stepConfirm.classList.remove('hidden');

    const payload = collectPayload(transport);
    
    // Add Rogue Specifics
    payload['Appointment Type'] = selectedType;
    payload['Date'] = container.querySelector('#rogueDate').value.trim();
    payload['Time'] = container.querySelector('#rogueTime').value.trim();
    payload['AM or PM'] = container.querySelector('#rogueAmPm').value;
    payload['Scheduled By'] = (typeof getSchedulerName === 'function') ? getSchedulerName() : '';

    // Save Cache (Normal cache, rogue date not cached)
    setClientCache(payload);

    google.script.run
      .withSuccessHandler(res => {
         if(!res.ok) { stepConfirm.innerHTML = `<p class="error">${res.error}</p>`; return; }
         showConfirmation();
      })
      .withFailureHandler(err => {
         stepConfirm.innerHTML = `<p class="error">Server error booking rogue appointment.</p>`;
      })
      .apiCreateRogueAppointment(payload);
  }

  function showConfirmation() {
    stepConfirm.innerHTML = `
      <h2>Appointment Booked!</h2>
      <div class="actions">
        <button id="bookAnotherBtn" class="btn">Book another appointment for this client</button>
        <button id="doneBtn" class="btn secondary">Done</button>
      </div>
    `;
    container.querySelector('#bookAnotherBtn').addEventListener('click', () => {
      // If we went rogue, we reset rogue mode for the next one
      isRogueMode = false;
      selectedSlot = null;
      renderScheduleFlow(container);
      scrollTop();
    });
    container.querySelector('#doneBtn').addEventListener('click', () => {
      clearClientCache();
      backBtn.click();
    });
  }
}
</script>