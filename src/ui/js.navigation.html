<script>
document.addEventListener('DOMContentLoaded', () => {
  const SPCA = window.SPCA || {};
  const { $$, backBtn, header, sectionTitle, mainMenu, views, clearClientCache } = SPCA;

  let customBackAction = null;

  SPCA.setBackHandler = (fn) => {
    customBackAction = fn;
  };

  // Tile navigation
  $$('.tile').forEach(btn => {
    btn.addEventListener('click', () => openView(btn.dataset.view));
  });

  // Back button
  backBtn.addEventListener('click', () => {
    if (typeof customBackAction === 'function') {
      customBackAction();
      return;
    }

    // Default: Return to Main Menu
    if (typeof clearClientCache === 'function') clearClientCache();
    header.classList.add('hidden');
    sectionTitle.textContent = 'Grant Appointment Scheduling';

    views.forEach(v => {
      v.classList.add('hidden');
      // Optional: clear view content when leaving a flow
      v.innerHTML = '';
    });

    mainMenu.classList.remove('hidden');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  function openView(view) {
    customBackAction = null;

    mainMenu.classList.add('hidden');
    header.classList.remove('hidden');
    sectionTitle.textContent = viewTitle(view);

    views.forEach(v => v.classList.add('hidden'));

    const target = document.querySelector(`#view-${view}`);
    if (!target) {
      console.error(`Missing container: #view-${view}`);
      return;
    }

    // Always clear the target before rendering to avoid "coming soon" / stale UI
    target.innerHTML = '';
    target.classList.remove('hidden');

    // Call the renderer. Each flow handles its own identity check if needed.
    if (view === 'schedule' && typeof window.renderScheduleFlow === 'function') {
      window.renderScheduleFlow(target);
      return;
    }
    if (view === 'modify' && typeof window.renderModifyFlow === 'function') {
      window.renderModifyFlow(target);
      return;
    }
    if (view === 'cancel' && typeof window.renderCancelFlow === 'function') {
      window.renderCancelFlow(target);
      return;
    }
    if (view === 'outcome' && typeof window.renderOutcomeFlow === 'function') {
      window.renderOutcomeFlow(target);
      return;
    }

    // Fallback if a renderer is missing
    target.innerHTML = `<p class="error">This flow is not available (missing renderer).</p>`;
  }

  function viewTitle(view) {
    return {
      schedule: 'Schedule New Appointment',
      modify:   'Modify Existing Appointment',
      cancel:   'Cancel Appointment',
      outcome:  'Log Appointment Outcome'
    }[view] || 'Grant Appointment Scheduling';
  }

  window.openView = openView;
});
</script>