<script>
document.addEventListener('DOMContentLoaded', () => {
  const { $$, backBtn, header, sectionTitle, mainMenu, views, clearClientCache } = window.SPCA;

  // ─── Custom Back Handler Logic ───
  // This allows specific flows (Schedule/Modify) to override the back button
  // behavior (e.g. go to previous step) instead of exiting to the main menu.
  let customBackAction = null;

  window.SPCA.setBackHandler = (fn) => {
    customBackAction = fn;
  };

  // ─── Tile navigation ───────────────────────────
  $$('.tile').forEach(btn => {
    btn.addEventListener('click', () => openView(btn.dataset.view));
  });

  // ─── Back button: return to main menu OR custom step ──────────
  backBtn.addEventListener('click', () => {
    // 1. If a flow has set a custom back action, run it
    if (typeof customBackAction === 'function') {
      customBackAction();
      return;
    }

    // 2. Default: Return to Main Menu
    clearClientCache();
    header.classList.add('hidden');
    sectionTitle.textContent = '';
    views.forEach(v => v.classList.add('hidden'));
    mainMenu.classList.remove('hidden');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  // ─── View switching logic ──────────────────────
  function openView(view) {
    // Reset handler when entering a new top-level view
    customBackAction = null;

    mainMenu.classList.add('hidden');
    header.classList.remove('hidden');
    sectionTitle.textContent = viewTitle(view);
    views.forEach(v => v.classList.add('hidden'));

    const target = document.querySelector(`#view-${view}`);
    target.classList.remove('hidden');

    // 1. Handle "Schedule" and "Modify" (Explicit Identity Check Wrapper)
    if ((view === 'schedule' || view === 'modify') && typeof showWhoAreYouScreen === 'function') {
      showWhoAreYouScreen(target, () => {
        if (view === 'schedule' && typeof renderScheduleFlow === 'function') {
          renderScheduleFlow(target);
        } else if (view === 'modify' && typeof renderModifyFlow === 'function') {
          renderModifyFlow(target);
        }
      });
    } 
    // 2. Fallback for Schedule/Modify if identity check fails/missing
    else if (view === 'schedule' && typeof renderScheduleFlow === 'function') {
      renderScheduleFlow(target);
    } 
    else if (view === 'modify' && typeof renderModifyFlow === 'function') {
      renderModifyFlow(target);
    } 
    // 3. Handle "Cancel" (Has its own internal Identity Check)
    else if (view === 'cancel' && typeof renderCancelFlow === 'function') {
       renderCancelFlow(target);
    }
    else if (view === 'outcome' && typeof renderOutcomeFlow === 'function') {
       renderOutcomeFlow(target);
    }
  }

  // ─── Section title resolver ─────────────────────
  function viewTitle(view) {
    return {
      schedule: 'Schedule New Appointment',
      modify:   'Modify Existing Appointment',
      cancel:   'Cancel Appointment',
      outcome:  'Log Appointment Outcome'
    }[view] || '';
  }

  // Expose globally
  window.openView = openView;
});
</script>